{% extends 'base.html' %}
{% load static tailwind_tags %}
{% block content %}
<div id="page-wrapper" class="flex flex-box mx-auto pt-24 justify-center h-[calc(100vh-3rem)] w-[90%] transition-all duration-200">
    <div class="h-full w-[95%] bg-gray-800 rounded-2xl shadow-md shadow-black flex flex-col gap-y-12 px-20 justify-center text-center items-center relative">
            <h2 id="question-answer" class="bg-gray-700 px-3 py-3 max-h-[40vh] max-w-[80vw] rounded text-white font-bold text-center flex items-center justify-center shadow-[0_0px_15px_rgba(0,0,0,0.9)] shadow-purple-600 cursor-default">{{ question.answer }}</h2>
            <div class="flex flex-col gap-y-4 align-items-center">
                <form method="POST" id="answer-form" action="{% url 'submitAnswer' board.id session.id %}" class="flex flex-col gap-y-4 align-items-center" >
                    {% csrf_token %}
                    <input id="answer-input" required name="answer-input" autocomplete="off" 
                    class="bg-gray-600 text-2xl py-2 focus:shadow-[0_0px_15px_rgba(0,0,0,0.9)] shadow-md shadow-black focus:shadow-purple-600 focus:border-purple-800 focus:outline-0 text-center rounded border-3 border-purple-950 text-white" 
                    placeholder="Answer" />
                    <h2 id="correct-answer" class="hidden text-2xl text-white"></h2>
                    <button id="submit-button" type="submit" class="text-center bg-blue-800 text-white px-10 w-full py-3 shadow-md shadow-black hover:shadow-[0_0px_15px_rgba(0,0,0,0.9)] hover:shadow-blue-600 hover:bg-blue-600 font-bold text-2xl rounded-2xl">Submit</button>
                    <input type="hidden" name="question_id" value="{{ question.id }}" />
                </form>
                    <div class="h-fit w-fit flex flex-row gap-x-3">
                        <button id="hint-button" class="w-full text-center bg-orange-400 text-white px-10 py-3 shadow-md shadow-black hover:shadow-[0_0px_15px_rgba(0,0,0,0.9)] hover:shadow-orange-300 hover:bg-orange-300 font-bold text-2xl rounded-2xl">Hint</button>
                        <a href="{% url 'sessionEditConcept' board.id question.id session.id %}" id="edit-button" class="hidden w-full text-center bg-indigo-500 text-white px-10 py-3 shadow-md shadow-black hover:shadow-[0_0px_15px_rgba(0,0,0,0.9)] hover:shadow-indigo-400 hover:bg-indigo-400 font-bold text-2xl rounded-2xl">Edit</a>
                    </div>
                <a href="{% url 'boardPage' board.id %}" class="absolute top-4 right-4 px-3 py-2 bg-red-600 rounded-3xl text-lg text-white shadow-md shadow-black">X</a>
                <div id="hint" class="hidden h-max-[20%] w-max-[80%] h-fit w-fit bg-gray-700 text-2xl text-white px-2 py-2 rounded shadow-[0_0px_15px_rgba(0,0,0,0.9)] shadow-orange-400">
                        <p>{{ question.hint }}</p>
                    </div>
            </div>
    </div>
</div>

    <!--Fitty to help text sizing-->
    <script src="https://unpkg.com/fitty/dist/fitty.min.js"></script>
<script>


    const boardId = '{{ board.id }}' 
    const sessionId = '{{ session.id }}'
    const csrf_token = document.querySelector('[name=csrfmiddlewaretoken]').value;

    const answerForm = document.getElementById('answer-form');
    const answerInput = document.getElementById('answer-input');
    const questionAnswer = document.getElementById('question-answer');
    const questionId = answerForm.querySelector('[name="question_id"]');
    const submitButton = document.getElementById('submit-button');
    const correctAnswer = document.getElementById('correct-answer');
    const hintBtn = document.getElementById('hint-button');
    const editBtn = document.getElementById('edit-button');
    const hint = document.getElementById('hint');

    let canSubmitAnswer = true;

    const questionFitty = fitty('#question-answer', {
        maxSize: 92,
        minSize: 18
    });

    async function submitAnswer() {
        const formData = new FormData(answerForm);
        const answerValue = answerInput.value.trim();
        if(!answerValue){
            alert('No Answer Given');
            return;
        }

        const response = await fetch(answerForm.action, {
            method : 'POST',
            body : formData,
            headers : {
                'X-CSRFToken' : formData.get('csrfmiddlewaretoken')
            }
        });

        const data = await response.json();

        if (data.success) {
            submitButton.textContent = 'Next';
            submitButton.classList.remove('bg-blue-800', 'hover:bg-blue-600', 'hover:shadow-blue-600');
            submitButton.classList.add('bg-green-600', 'hover:bg-green-600', 'hover:shadow-green-600');
            hint.classList.add('hidden');
            editBtn.classList.remove('hidden');
            canSubmitAnswer = false;
            if(data.result) {
                questionAnswer.classList.add('shadow-green-600');
                answerInput.classList.remove('shadow-md');
                answerInput.classList.add('shadow-[0_0px_15px_rgba(0,0,0,0.9)]', 'border-green-500', 'shadow-green-500', 'focus:border-green-500', 'focus:shadow-green-500');
            } else {
                questionAnswer.classList.add('shadow-red-600');
                answerInput.classList.remove('shadow-md');
                answerInput.classList.add('shadow-[0_0px_15px_rgba(0,0,0,0.9)]', 'border-red-500', 'shadow-red-500', 'focus:border-red-500', 'focus:shadow-red-500');
                correctAnswer.classList.remove('hidden');
                correctAnswer.textContent = data.answer;
            }     
        } else {
            alert('Something Went Wrong');
        }
    }
    // Works To submit and get data for next question
    async function nextQuestion () {
        const currentQuestionId = questionId.value;

        const response = await fetch(`/board/${boardId}/sessions/${sessionId}/newQuestion/`, {
            method: 'POST',
            headers : {
                'Content-Type' : 'application/json',
                'X-CSRFToken' : csrf_token
            },
            body : JSON.stringify({ questionId : currentQuestionId })
        });

        const data = await response.json();

        if (data.success) {
            questionAnswer.textContent = data.questionAnswer;
            questionFitty[0].fit();
            questionId.value = data.questionId;
            console.log(data.questionAnswer)
            submitButton.textContent = 'Submit';
            submitButton.classList.remove('bg-green-600', 'hover:bg-green-600', 'hover:shadow-green-600');
            submitButton.classList.add('bg-blue-800', 'hover:bg-blue-600', 'hover:shadow-blue-600');
            questionAnswer.classList.remove('shadow-green-600', 'shadow-red-600');
            questionAnswer.classList.add('shadow-purple-600');
            answerInput.classList.remove('shadow-[0_0px_15px_rgba(0,0,0,0.9)]', 'shadow','border-green-500', 'shadow-green-500', 'focus:border-green-500', 'focus:shadow-green-500');
            answerInput.classList.remove('shadow-[0_0px_15px_rgba(0,0,0,0.9)]', 'border-red-500', 'shadow-red-500', 'focus:border-red-500', 'focus:shadow-red-500');
            answerInput.classList.add('shadow-md');
            editBtn.classList.add('hidden');
            editBtn.href = `/board/${boardId}/concepts/${data.questionId}/session/${sessionId}/`;
            hint.textContent = data.questionHint;
            hint.classList.add('hidden');
            if(!correctAnswer.classList.contains('hidden')) correctAnswer.classList.add('hidden');
            answerForm.reset();
            canSubmitAnswer = true;
        } else {
            alert('Fail');
        }
    }

    hintBtn.addEventListener('click', () => {
        hint.classList.toggle('hidden');
    });

    answerInput.addEventListener('keydown', async (e) => {
        if(e.key === 'Enter'){
            e.preventDefault();
            if(canSubmitAnswer) {
                await submitAnswer();
            } else {
                await nextQuestion();
                canSubmitAnswer = true;
            }
        }
    });

    submitButton.addEventListener('click', async (e) => {
        e.preventDefault();
        if(canSubmitAnswer){
            await submitAnswer();
        } else {
            await nextQuestion();
            canSubmitAnswer = true;
        }
    });

/*    // Allows to make sure when reloading the page you are redirected back to the main page and cant continue that learning session
    window.addEventListener('load', () => {
        const navigationEntries = performance.getEntriesByType('navigation');
        const type = navigationEntries.length > 0 ? navigationEntries[0].type : null
        if(type === 'reload'){
            window.location.href = `/board/${boardId}/`;
        }
    });
*/
</script>
{% endblock %}