{% extends 'base.html' %}
{% load static tailwind_tags %}
{% block content %}
<meta name="csrf_token" content="{{ csrf_token }}">

<div id="page-wrapper" class="flex flex-box mx-auto pt-24 justify-center h-[calc(100vh-3rem)] w-[90%] transition-all duration-200">
    <div class="h-full w-[95%] bg-gray-800 rounded-2xl shadow-md shadow-black">
        <div class="w-full h-full flex-1 flex flex-col min-w-0 align-items-center justify-content-center gap-y-4 py-2">
            <!--Input for Setting the Sessions Title-->
            <div class="bg-gray-700 focus-within:bg-gray-600 h-fit w-[90%] rounded-2xl">
                <input id="session-title" autocomplete="off" placeholder="{% if sessionSettings %}{{ sessionSettings.title }}{% else %}Session Title{% endif %}" value="{% if sessionSettings %}{{ sessionSettings.title }}{% else %}{% endif %}" class=" bg-transparent w-full h-full focus:outline-none text-white text-2xl font-bold text-center px-2 py-3 rounded-2xl focus:shadow-[0_0px_15px_rgba(0,0,0,0.9)] focus:shadow-purple-500 focus:border-2 focus:border-purple-600" />
            </div>
            <div class="w-[90%] h-[80%] gap-y-2 justify-content-center align-items-center flex flex-row gap-x-5">
            <!--Sets all tags for the current session-->
                <div class="w-[80%] h-[80%] flex flex-col gap-y-2 justify-content-center align-items-center">
                    <!--Left side for tag filters-->
                    <!--Header for Tag Filter-->
                    <div class="bg-gray-600 w-full h-fit rounded-2xl shadow-md shadow-black">
                        <h2 class="text-white text-2xl font-bold text-center px-2 py-3 cursor-default">Tag Filter</h2>
                    </div>
                    <div class="h-full w-full bg-gray-900 rounded-2xl flex flex-row gap-x-3 p-3">
                        <!--Add Tags from left-->
                        <div class="h-full w-full bg-gray-800 rounded-2xl flex flex-col gap-y-6">
                            <!--Header Section-->
                            <div class="h-fit w-full  px-1 py-2 gap-y-2 flex flex-col align-items-center">   
                                <h2 class="text-xl text-white font-bold text-center cursor-default">Add Tags</h2>
                                <div class="w-[90%] flex flex-row justify-between bg-green-800 border rounded">
                                    <input id="available-tags-search" placeholder="Search" class="bg-transparent outline-none w-full text-lg text-center rounded">
                                    <button id="clear-available-tag-search" class="content-end px-2 py-1 rounded text-md text-white bg-red-500">X</button>
                                </div>
                                <div class="flex flex-row shrink-0 justify-content-center gap-x-2 w-[90%]">
                                <button id="create-tag" class="bg-gray-600 w-full py-2 rounded border-2 border-transparent text-purple-300 text-xl font-bold hover:shadow-[0_0px_8px_rgba(0,0,0,0.9)] hover:shadow-purple-500 hover:border-2 hover:border-purple-600 hover:text-purple-500">Create Tag</button>
                                    <button id="select-all" class="bg-gray-600 w-full py-2 rounded border-2 border-transparent text-blue-300 text-xl font-bold hover:shadow-[0_0px_8px_rgba(0,0,0,0.9)] hover:shadow-blue-500 hover:border-2 hover:border-blue-600 hover:text-blue-500">Select All</button>
                                </div>
                            </div>
                            <!--Section for all Tags-->
                            <div class="flex-1 overflow-y-auto w-full">
                                <div id="available-tags" class="grid grid-cols-2 gap-x-2 gap-y-3 py-1 px-2 h-fit w-full">
                                </div>
                            </div>
                        </div>
                        <!--Current Added Tags-->
                        <div class="h-full w-full bg-gray-800 rounded-2xl flex flex-col gap-y-6">
                            <div class="h-fit w-full px-1 py-2 gap-y-2 flex flex-col align-items-center">   
                                <h2 class="text-xl text-white font-bold text-center cursor-default">Current Tags</h2>
                                <div class="w-[90%] flex flex-row justify-between bg-green-800 rounded border">
                                    <input id="session-tags-search" placeholder="Search" class="bg-transparent w-full text-lg text-center rounded">
                                    <button id="clear-session-tag-search" class="content-end px-2 py-1 rounded text-md text-white bg-red-500">X</button>
                                </div>
                                <div class="flex flex-row w-[90%] shrink-0 justify-content-center gap-x-2">
                                    <button id="exclusive" class="{% if sessionSettings.isExclusive %}bg-green-600 text-gray-700 hover:text-gray-950{% else %}bg-gray-600 text-green-300{% endif %} w-full py-2 rounded border-2 border-transparent text-xl font-bold hover:shadow-[0_0px_8px_rgba(0,0,0,0.9)] hover:shadow-green-500 hover:border-2 hover:border-green-600 hover:text-green-500">Exclusive</button>
                                    <button id="deselect-all" class="bg-gray-600 w-full py-2 rounded border-2 border-transparent text-red-300 text-xl font-bold hover:shadow-[0_0px_8px_rgba(0,0,0,0.9)] hover:shadow-red-500 hover:border-2 hover:border-red-600 hover:text-red-500">Deselect All</button>
                                </div>
                            </div>
                            <!--Section for current added Tags-->
                            <div class="flex-1 overflow-y-auto w-full">
                                <div id="session-tags" class="grid grid-cols-2 gap-x-4 gap-y-4 py-1 px-2 h-fit w-full">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="w-[20%] h-full flex flex-col gap-y-2 rounded-2xl pt-7 pb-7">
                    <div class="w-full h-fit text-center justify-content-center align-items-center bg-gray-600 rounded-2xl shadow-md shadow-black">
                        <h2 class="text-2xl text-white py-3 font-bold cursor-default">Settings</h2>
                    </div>
                    <div class="w-full h-full bg-gray-900 rounded-2xl py-2 justify-items-center">
                        <!--Questions Dropdown-->
                        <div class="relative w-[90%]">
                            <div class="w-full h-fit flex flex-col bg-gray-700 rounded-2xl align-items-center px-1 py-2 gap-y-3">
                                <h2 class="text-2xl text-white">Question Type</h2>
                                <button type="button" id="question-dropdown" class="shadow-md shadow-black border-none bg-gray-600 px-4 text-gray-200 w-full py-2 rounded flex justify-between items-center hover:shadow-[0_0px_15px_rgba(0,0,0,0.9)] hover:shadow-purple-500 cursor-pointer hover:bg-gray-700 focus:shadow-[0_0px_15px_rgba(0,0,0,0.9)] focus:shadow-purple-500 ">
                                    <span id="question-dropdown-text">{{ defaultQuestion }}</span>
                                    <svg id="downarrow-chevron" class="w-5 h-5 bg-gray-400 rounded text-gray-600" fill="none" stroke="currentColor" viewbox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M19 9l-7 7-7-7" />
                                    </svg> 
                                </button> 
                            </div>
                            <!--Concept amount dropdown-->
                            <div id="questions-menu" class="hidden absolute left-1/2 transform text-center -translate-x-1/2 mt-1 w-full  rounded-md shadow-lg z-20 bg-gray-600">
                                <div class="py-1">
                                    {% for option in options %}
                                        <button type="button" onclick="selectQuestion('{{ option.title }}')" class="w-full text-left px-4 py-2 text-sm text-gray-300 hover:bg-gray-500">{{ option.formattedTitle }}</button>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex flex-row gap-x-2">
                <a href="{% url 'boardPage' board.id %}"  class="bg-orange-500 px-4 py-2 text-2xl text-white font-bold rounded-2xl">Return</a>
                <button id="save-button" class="bg-blue-500 px-4 py-2 text-2xl text-white font-bold rounded-2xl">Save</button>
                {% if sessionSettings %}
                <button id="start-session" onclick="startSessionFunc()" class="bg-green-500 px-12 py-2 text-2xl text-white font-bold rounded-2xl">Start Session</button> 
                <button id="delete-session-settings" class="bg-red-500 px-4 py-2 text-2xl text-white font-bold rounded-2xl">Delete</button>  
                {% endif %}
            </div>
        </div>
    </div>
</div>
<!--Acts as the blurred background to cover main page-->
<div id="modal-backdrop" class="hidden fixed inset-0  bg-black/50 backdrop-blur-sm">></div>
    <!--Main modal for adding a tag-->
    <div id="new-tag-modal" class="hidden flex flex-row fixed inset-x-[25%] inset-y-[40%] w-[50%] h-[6vw] rounded-2xl bg-gray-500 z-100 align-content-center">
        <div class="flex flex-row h-full w-full py-2 px-3 gap-x-14 align-items-center">
            <!--Icon Capability for tags-->
            <div class="bg-gray-700 text-white p-3 rounded-2xl hover:shadow-[0_0px_15px_rgba(0,0,0,0.9)] hover:shadow-purple-500 cursor-pointer hover:bg-gray-800 text-2xl font-bold">Img</div>
            <input id="tag-name" placeholder="Tag Name" class="bg-gray-700 text-white text-2xl font-bold p-3 rounded-2xl hover:shadow-[0_0px_15px_rgba(0,0,0,0.9)] hover:shadow-purple-500 hover:bg-gray-800" />
            <button id="confirm-create-tag" class="justify-self-end bg-gray-700 text-white text-2xl font-bold p-3 rounded-2xl hover:shadow-[0_0px_15px_rgba(0,0,0,0.9)] hover:shadow-green-500 hover:bg-gray-800 absolute right-16">Confirm</button>
            <button onclick="closeNewTagModal()" class="absolute top-3.5 right-2 bg-red-600 rounded-xl px-3 py-3 hover:bg-red-800">X</button>
        </div>
    </div>
    <!--Permanently Delete SessionSettings Modal Popup-->
    {% if sessionSettings %}
    <div id="delete-session-settings-confirm" class="hidden flex flex-col fixed inset-x-[25%] inset-y-[40%] w-[50%] h-[6vw] rounded-2xl bg-gray-700 z-100 justify-content-center align-items-center">
        <h2 class="text-2xl text-white text-center pb-3">Do you want to permanently delete these Session Settings?</h2>
        <form method="POST" action="{% url 'deleteSessionSettings' board.id sessionSettings.id %}">
            {% csrf_token %}
            <button type="submit" class="bg-red-500 py-1 rounded  text-lg font-bold px-4 hover:bg-red-800">Delete</button>
        </form>
        <button id="cancel-delete-session-settings" class="absolute top-2 right-2 bg-red-600 rounded px-2 text-white hover:bg-red-800">X</button>
    </div>
    {% endif %}
    <!--Permanently Delete Tag Modal Popup-->
    <div id="delete-tag-confirm" class="hidden flex flex-col fixed inset-x-[25%] inset-y-[40%] w-[50%] h-[6vw] rounded-2xl bg-gray-700 z-100 justify-content-center align-items-center">
        <h2 class="text-2xl text-white text-center pb-3">Do you want to permanently delete this tag?</h2>
        <button id="confirm-tag-delete" class="bg-red-500 py-1 rounded w-fit h-fit text-lg font-bold px-4 hover:bg-red-800">Delete</button>
        <button id="cancel-tag-delete" class="absolute top-2 right-2 bg-red-600 rounded px-2 text-white hover:bg-red-800">X</button>
    </div>
{% if sessionSettingsTags %}
    {{ sessionSettingsTags|json_script:"session-settings-tags-data" }}
{% endif %}
{{ availableTags|json_script:"available-tags-data"}}
<script>
    const csrfToken = document.querySelector('meta[name=csrf_token]').getAttribute('content');

    const sessionTags = document.getElementById('session-tags');
    const availableTags = document.getElementById('available-tags');

    const saveButton = document.getElementById('save-button');

    const sessionTitleData = document.getElementById('session-title');

    const modalBackdrop = document.getElementById('modal-backdrop');
    const deleteSessionSettingsBtn = document.getElementById('delete-session-settings');
    const deleteSessionSettingsModal = document.getElementById('delete-session-settings-confirm');
    const cancelDeleteSessionSettings = document.getElementById('cancel-delete-session-settings');

    const deleteTagConfirmModal = document.getElementById('delete-tag-confirm');
    const cancelTagDelete = document.getElementById('cancel-tag-delete');
    const confirmTagDeleteBtn = document.getElementById('confirm-tag-delete');

    const newTagModal = document.getElementById('new-tag-modal');
    const createTag = document.getElementById('create-tag')
    const createTagBtn = document.getElementById('confirm-create-tag');
    const newTagName = document.getElementById('tag-name');

    const startSession = document.getElementById('start-session');
    
    const exclusiveBtn = document.getElementById('exclusive');

    const selectAll = document.getElementById('select-all');
    const deselectAll = document.getElementById('deselect-all');

    const availableTagsSearch = document.getElementById('available-tags-search');
    const sessionTagsSearch = document.getElementById('session-tags-search');

    const clearSessionTagSearch = document.getElementById("clear-session-tag-search");
    const clearAvailableTagSearch = document.getElementById('clear-available-tag-search');

    const questionDropdownBtn = document.getElementById('question-dropdown');
    const questionsMenu = document.getElementById('questions-menu');
    const questionDropdownText = document.getElementById('question-dropdown-text')
    let questionValue = '{{ defaultQuestion }}';


    let stagedTags = [];
    let isExclusive = "{{ sessionSettings.isExclusive|yesno:'true,false' }}" === 'true' || false ;
    const boardId = "{{ board.id }}";
    const sessionSettingsId = "{{ sessionSettings.id }}";


    function createTagButton(tag, isSessionTag = false) {
            const button = document.createElement('button');
            button.className = isSessionTag ? 'sessionTag text-center bg-gray-700 text-white rounded-2xl hover:shadow-[0_0px_15px_rgba(0,0,0,0.9)] hover:shadow-purple-900 hover:bg-gray-800 rounded-2xl w-full h-8 relative'
                                            : 'availableTag text-center bg-gray-700 text-white rounded-2xl hover:shadow-[0_0px_15px_rgba(0,0,0,0.9)] hover:shadow-purple-900 hover:bg-gray-800 rounded-2xl w-full h-8 relative';
            button.dataset.id = tag.id;
            button.textContent = tag.name;

            const removeTagButton = document.createElement('button');
            removeTagButton.textContent = 'X';
            removeTagButton.className = 'absolute right-2 top-2 bg-red-500 text-white text-xs px-1 rounded';
            removeTagButton.onclick = (e) => { 
                e.stopPropagation();
                openConfirmTagDeleteModal(tag.id);
            }

            button.appendChild(removeTagButton);

            return button;
    }

    function openNewTagModal() {
        newTagModal.classList.remove('hidden');
        modalBackdrop.classList.remove('hidden');
    }

    function closeNewTagModal() {
        newTagModal.classList.add('hidden');
        modalBackdrop.classList.add('hidden');
    }

    function closeConfirmTagDeleteModal() {
        deleteTagConfirmModal.classList.add('hidden');
        modalBackdrop.classList.add('hidden');
        confirmTagDeleteBtn.dataset.tagId = '';
    }

    function openConfirmTagDeleteModal(tagId) {
        deleteTagConfirmModal.classList.remove('hidden');
        confirmTagDeleteBtn.dataset.tagId = tagId;
        modalBackdrop.classList.remove('hidden');
    }

    function selectQuestion(value) {
        const questionText =`${value.split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ')}`;
        questionDropdownText.innerText = questionText;
        questionValue = value;
        questionsMenu.classList.add('hidden');
    }
 
    cancelTagDelete.addEventListener('click', () => {
        closeConfirmTagDeleteModal();
    });

    questionDropdownBtn.addEventListener('click', () => {
        if(questionsMenu.classList.contains('hidden')){
        questionsMenu.classList.remove('hidden');
        } else {
            questionsMenu.classList.add('hidden');
        }
    });

    exclusiveBtn.addEventListener('click', () => {
        if(!isExclusive){
            isExclusive = true;
            exclusiveBtn.classList.remove('bg-gray-600', 'text-green-300');
            exclusiveBtn.classList.add('bg-green-600','text-gray-700', 'hover:text-gray-950');
        } else {
            isExclusive = false;
           exclusiveBtn.classList.remove('bg-green-600', 'text-gray-700', 'hover:text-gray-950');
            exclusiveBtn.classList.add('bg-gray-600', 'text-green-300');
        }
    });

    clearAvailableTagSearch.addEventListener('click', () => {
        availableTagsSearch.value = '';
        availableTagsSearch.dispatchEvent(new Event('input', {bubbles: true }));
    });

    clearSessionTagSearch.addEventListener('click', () => {
        sessionTagsSearch.value = '';
        sessionTagsSearch.dispatchEvent(new Event('input', {bubbles: true }));
    });

    modalBackdrop.addEventListener('click', (e) => {
        modalBackdrop.classList.add('hidden');
        if(deleteSessionSettingsModal) {deleteSessionSettingsModal.classList.add('hidden');}
        if(newTagModal) {newTagModal.classList.add('hidden');}
    });

    newTagModal.addEventListener('click', (e) => {
        e.stopPropagation();
    });

    if(sessionSettingsId){
        deleteSessionSettingsBtn.addEventListener('click', (e) => {
            modalBackdrop.classList.remove('hidden');
            deleteSessionSettingsModal.classList.remove('hidden');
        })
        cancelDeleteSessionSettings.addEventListener('click', (e) => {
            deleteSessionSettingsModal.classList.add('hidden');
            modalBackdrop.classList.add('hidden');
        });
    }

    sessionTagsSearch.addEventListener('input', (e) => { 
        const sessionTagBtns = document.querySelectorAll('.sessionTag');
        sessionTagBtns.forEach(btn => {
            if(!btn.textContent.toLowerCase().startsWith(e.target.value.toLowerCase())) {
                btn.classList.add('hidden'); 
            } else {
                btn.classList.remove('hidden');  
            }
        });
    });

    availableTagsSearch.addEventListener('input', (e) => {
        const availableTagBtns = document.querySelectorAll('.availableTag');
        availableTagBtns.forEach(btn => {
            if(!btn.textContent.toLowerCase().startsWith(e.target.value.toLowerCase())) {
                btn.classList.add('hidden');    
            } else {
                btn.classList.remove('hidden');  
            }
        });
    });

    // Closes the delete modal popup
    cancelTagDelete.addEventListener('click', () => {
        deleteTagConfirm.classList.add('hidden');
        modalBackdrop.classList.add('hidden');
    });

    createTag.addEventListener('click', () => {
        newTagModal.classList.remove('hidden');
        modalBackdrop.classList.remove('hidden');
    });

    function startSessionFunc(){
        const sessionBtns = document.querySelectorAll('.sessionTag');
        let addTags = Array.from(sessionBtns).map(btn => btn.dataset.id);

        fetch(`/board/${boardId}/sessions/${sessionSettingsId}/sessionStart/`, {
            method : 'POST',
            headers : {
                'X-CSRFToken' :csrfToken,
                'Content-Type' : 'application/json'
            },
            body : JSON.stringify({ tags : addTags, isExclusive : isExclusive, question : questionValue })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                window.location.href = data.redirect_url;
            } else {
                alert('Failed');
            }
        })
    }
   
    createTagBtn.addEventListener('click', () => {
            fetch(`/board/${boardId}/tags/createTag/`, {
                method : 'POST',
                headers : {
                    'X-CSRFToken' : csrfToken,
                    'Content-Type' : 'application/json'
                },
                body : JSON.stringify({name : newTagName.value })
            })
            .then(res => res.json())
            .then(data => {
                console.log('Added Tag', data);
                availableTags.append(createTagButton(data, false));
                newTagName.value = '';
                closeNewTagModal();
            })
            .catch(err => console.error('Tag Failed', err));
    });
    

    // Event listener to handle fully deleting a tag after confirm delete popup
    confirmTagDeleteBtn.addEventListener('click', () => {
        const tagId = confirmTagDeleteBtn.dataset.tagId;
        if(!tagId) return;
            fetch(`/tag/${tagId}/delete/`, {
                method: 'POST',
                headers: { 'X-CSRFToken' : csrfToken }
            })
            .then(res => res.json())
            .then(data => {
                if(data.success) {
                    document.querySelector(`[data-id="${tagId}"]`)?.remove();
                    closeConfirmTagDeleteModal();
                } else {
                    alert('Failed to delete tag: ' + data.error);
                }
            });
    });

    saveButton.addEventListener('click', () => {
        const sessionTitle = sessionTitleData.value.trim() || sessionTitleData.placeholder;
        let fetchLink = '';
        if(sessionSettingsId){
            fetchLink = `/board/${boardId}/sessions/${sessionSettingsId}/update/`;
        } else {
            fetchLink = `/board/${boardId}/sessions/newSessionSettings/`;
        }
        fetch(fetchLink, {
            method : 'POST',
            headers : {
                'X-CSRFToken' : csrfToken,
                'Content-Type' : 'application/json'
            },
            body : JSON.stringify({title : sessionTitle, tags : stagedTags, isExclusive : isExclusive, question : questionValue})
        })
        .then(res => res.json())
        .then(data => {
            sessionTitleData.placeholder = sessionTitle;
            sessionTitleData.value = sessionTitle;
            if(data.success) {
                window.location.href = data.redirect_url;
            }
        })
        .catch(err => console.error('Submit Failed', err))
    });

    selectAll.addEventListener('click', () => {
        const buttons = document.querySelectorAll('.availableTag');
        buttons.forEach(btn => {
            stagedTags.push(btn.dataset.id);
            btn.classList.toggle('sessionTag');
            btn.classList.toggle('availableTag');
            sessionTags.append(btn);
        })
    });

    deselectAll.addEventListener('click', () => {
        const buttons = document.querySelectorAll('.sessionTag');
        buttons.forEach(btn => {
            stagedTags.pop(btn.dataset.id);
            btn.classList.toggle('sessionTag');
            btn.classList.toggle('availableTag');
            availableTags.append(btn);
        })
    });

    document.addEventListener('click', (e) => {
        if(e.target.classList.contains('sessionTag') || e.target.classList.contains('availableTag')) {
            const button = e.target.closest('button');
            const tagId = button.dataset.id;
            const isSessionTag = button.classList.contains('sessionTag');

            if(!isSessionTag){
                stagedTags.push(tagId);
            } else {
                stagedTags = stagedTags.filter(id => id !== tagId);
            }

            button.classList.toggle('sessionTag');
            button.classList.toggle('availableTag');
            const parent = button.parentElement.id === 'session-tags' ? availableTags : sessionTags;
            parent.appendChild(button);
        }
    });

    // Used to dynamically load tag button when the dom is loaded, easy to implement deletion button methodology compared to an html forloop 
    document.addEventListener('DOMContentLoaded', () => {
        const availableTagsData = JSON.parse(document.getElementById('available-tags-data').textContent);
        
        availableTags.innerHTML = '';
        availableTagsData.forEach(tag => {
            availableTags.appendChild(createTagButton(tag, false));
        });

        try { 
            const sessionSettingsTagsData = JSON.parse(document.getElementById('session-settings-tags-data').textContent);
            sessionTags.innerHTML = '';
            if(sessionSettingsTagsData) {
                sessionSettingsTagsData.forEach(tag => {
                    sessionTags.appendChild(createTagButton(tag, true))
                    stagedTags.push(tag.id)
                });
            }
        } catch(error){}
    });
</script>
{% endblock %}