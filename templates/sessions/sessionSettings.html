{% extends 'base.html' %}
{% load static tailwind_tags %}

{% block content %}
<meta name="csrf_token" content="{{ csrf_token }}">

<div id="page-wrapper" class="flex pt-20 pb-4 overflow-y-auto items-center justify-center h-full w-full">
    <div class="h-full w-[90%] flex flex-col gap-y-4 px-2 md:px-10 lg:px-15 text-center items-center relative py-4">
        <!--Session Title-->
        <input id="session-title" placeholder="Session Title" autocomplete="off" class="h-[10%] w-[80%] bg-gray-500 focus:shadow-[0_0px_15px_rgba(0,0,0,0.9)] focus:shadow-purple-500 shadow-md shadow-black outline-none text-3xl text-center py-4 rounded-2xl" />
        <!--Main Section-->
        <div class="h[30] lg:h-[75%] w-full flex flex-col lg:flex-row gap-y-3 gap-x-3">
            <!--Current added tags section-->
            <div class="flex-2 h-full flex flex-col gap-y-2 bg-gray-800 rounded-2xl py-2 px-2">
                <!--Header Section-->
                <h2 class="w-full h-fit text-center text-white text-2xl font-bold bg-gray-600 rounded">Current Tags</h2>
                <!--Search bar-->
                <div class="w-full h-fit items-center flex flex-row gap-x-1 bg-gray-700 focus-within:shadow-[0_0px_15px_rgba(0,0,0,0.9)] focus-within:shadow-purple-500 shadow-md shadow-black">
                    <input id="session-tags-search" placeholder="Search" class="flex-1 text-lg py-1 text-center rounded-2xl outline-none font-medium text-gray-500  " />
                    <button id="clear-session-tag-search" class="bg-red-600 px-2 h-full rounded hover:bg-red-800 cursor-pointer">X</button>
                </div>
                <!--Select / Deselect all-->
                <div class="w-full h-fit flex flex-row gap-x-2 ">
                    <button id="select-all" class="w-full bg-gray-600 text-white text-lg md:text-2xl font-bold p-3 rounded-2xl hover:shadow-[0_0px_15px_rgba(0,0,0,0.9)] hover:shadow-green-500 hover:bg-gray-800">select all</button>
                    <button id="deselect-all" class="w-full bg-gray-600 text-white text-lg md:text-2xl font-bold p-3 rounded-2xl hover:shadow-[0_0px_15px_rgba(0,0,0,0.9)] hover:shadow-green-500 hover:bg-gray-800">deselect all</button>
                    <button id="exclusive" class="w-full text-lg md:text-2xl text-white font-bold bg-gray-600 rounded-2xl cursor-pointer">Exclusive</button>
                </div>
                <!--Available Tags Grid-->
                <div id="session-tags" class="grid grid-cols-2 w-full h-full auto-rows-min gap-2 px-2 overflow-y-auto">
                </div>
            </div>
            <div class="flex-2 flex h-full flex-col gap-y-4">
                <!--Current added tags section-->
                <div class="flex-2 h-full flex flex-col gap-y-2 bg-gray-800 rounded-2xl py-2 px-2">
                    <!--Header Section-->
                    <h2 class="w-full text-center text-white text-2xl font-bold bg-gray-600 rounded">Available Tags</h2>
                    <!--Search bar-->
                    <div class="w-full items-center flex flex-row gap-x-1 bg-gray-700 focus-within:shadow-[0_0px_15px_rgba(0,0,0,0.9)] focus-within:shadow-purple-500 shadow-md shadow-black">
                        <input id="available-tags-search" placeholder="Search" class="flex-1 text-lg py-1 text-center rounded-2xl outline-none font-medium text-gray-500  " />
                        <button id="clear-available-tag-search" class="bg-red-600 px-2 h-full rounded hover:bg-red-800 cursor-pointer">X</button>
                    </div>
                    <!--Select / Deselect all-->
                    <div class="w-full flex flex-row gap-x-2">
                        <button id="select-all" class="w-full bg-gray-600 text-white text-lg md:text-2xl font-bold p-3 rounded-2xl hover:shadow-[0_0px_15px_rgba(0,0,0,0.9)] hover:shadow-green-500 hover:bg-gray-800">select all</button>
                        <button id="deselect-all" class="w-full bg-gray-600 text-white text-lg md:text-2xl font-bold p-3 rounded-2xl hover:shadow-[0_0px_15px_rgba(0,0,0,0.9)] hover:shadow-green-500 hover:bg-gray-800">deselect all</button>                   
                        <button id="create-tag" class="w-full text-lg md:text-2xl text-white font-bold bg-gray-600 rounded-2xl cursor-pointer">create</button>
                    </div>
                    <!--Session Tags Grid-->
                    <div id="available-tags" class="grid grid-cols-2 w-full h-full auto-rows-min gap-2 px-2 py-2 overflow-y-auto">
                    </div>
                </div>
            </div>
            <!--Settings Div-->
            <div class="flex-1 h-[30%] flex flex-col gap-y-2 ">
                <h2 class="text-white text-2xl font-bold w-full text-center">Default Questions</h2>
                <div id="selected-questions" class="lg:grid lg:grid-cols-2 gap-y-2 lg:grid-rows-2 flex flex-row gap-x-2 w-full h-fit">
                </div>
            </div>
        </div>
        <div class="h-[20%] w-full justify-center items-center grid grid-cols-2 grid-rows-2 md:flex md:flex-row gap-x-1 md:gap-x-4 gap-y-2 md:h-[10%]">
            <button id="confirm-create-tag" class=" bg-gray-700 text-white text-lg md:text-2xl font-bold p-2 md:p-3 rounded-2xl hover:shadow-[0_0px_15px_rgba(0,0,0,0.9)] hover:shadow-green-500 hover:bg-gray-800">Confirm</button>
            <button id="delete-session-settings" class=" bg-gray-700  text-white text-lg md:text-2xl font-bold p-2 md:p-3 rounded-2xl hover:shadow-[0_0px_15px_rgba(0,0,0,0.9)] hover:shadow-red-500 hover:bg-gray-800">Delete</button>
            <button id="save-button" class=" bg-gray-700 text-white text-lg md:text-2xl font-bold p-2 md:p-3 rounded-2xl hover:shadow-[0_0px_15px_rgba(0,0,0,0.9)] hover:shadow-blue-500 hover:bg-gray-800">Save</button>
            <button id="confirm-create-tag" class=" bg-gray-700 text-white text-lg md:text-2xl font-bold p-2 md:p-3 rounded-2xl hover:shadow-[0_0px_15px_rgba(0,0,0,0.9)] hover:shadow-green-500 hover:bg-gray-800">Start Study Session</button>
        </div>
    </div>
</div>
<!--Acts as the blurred background to cover main page-->
<div id="modal-backdrop" class="hidden fixed inset-0  bg-black/50 backdrop-blur-sm">
    <!--Main modal for adding a tag-->
    <div id="new-tag-modal" class="hidden flex flex-row fixed inset-x-[25%] inset-y-[40%] w-[50%] h-[6vw] rounded-2xl bg-gray-500 z-100 align-content-center">
        <div class="flex flex-row h-full w-full py-2 px-3 gap-x-14 align-items-center">
            <!--Icon Capability for tags-->
            <div class="bg-gray-700 text-white p-3 rounded-2xl hover:shadow-[0_0px_15px_rgba(0,0,0,0.9)] hover:shadow-purple-500 cursor-pointer hover:bg-gray-800 text-2xl font-bold">Img</div>
            <input id="tag-name" placeholder="Tag Name" class="bg-gray-700 text-white text-2xl font-bold p-3 rounded-2xl hover:shadow-[0_0px_15px_rgba(0,0,0,0.9)] hover:shadow-purple-500 hover:bg-gray-800" />
            <button id="confirm-create-tag" class="justify-self-end bg-gray-700 text-white text-2xl font-bold p-3 rounded-2xl hover:shadow-[0_0px_15px_rgba(0,0,0,0.9)] hover:shadow-green-500 hover:bg-gray-800 absolute right-16">Confirm</button>
            <button onclick="closeNewTagModal()" class="absolute top-3.5 right-2 bg-red-600 rounded-xl px-3 py-3 hover:bg-red-800">X</button>
        </div>
    </div>
    <!--Permanently Delete SessionSettings Modal Popup-->
    {% if sessionSettings %}
    <div id="delete-session-settings-confirm" class="hidden flex flex-col fixed inset-x-[25%] inset-y-[40%] w-[50%] h-[6vw] rounded-2xl bg-gray-700 z-100 justify-content-center align-items-center">
        <h2 class="text-2xl text-white text-center pb-3">Do you want to permanently delete these Session Settings?</h2>
        <form method="POST" action="{% url 'deleteSessionSettings' board.id sessionSettings.id %}">
            {% csrf_token %}
            <button type="submit" class="bg-red-500 py-1 rounded  text-lg font-bold px-4 hover:bg-red-800">Delete</button>
        </form>
        <button id="cancel-delete-session-settings" class="absolute top-2 right-2 bg-red-600 rounded px-2 text-white hover:bg-red-800">X</button>
    </div>
    {% endif %}
    <!--Permanently Delete Tag Modal Popup-->
    <div id="delete-tag-confirm" class="hidden flex flex-col fixed inset-x-[25%] inset-y-[40%] w-[50%] h-[6vw] rounded-2xl bg-gray-700 z-100 justify-content-center align-items-center">
        <h2 class="text-2xl text-white text-center pb-3">Do you want to permanently delete this tag?</h2>
        <button id="confirm-tag-delete" class="bg-red-500 py-1 rounded w-fit h-fit text-lg font-bold px-4 hover:bg-red-800">Delete</button>
        <button id="cancel-tag-delete" class="absolute top-2 right-2 bg-red-600 rounded px-2 text-white hover:bg-red-800">X</button>
    </div>
</div>
{% if sessionSettingsTags %}
    {{ sessionSettingsTags|json_script:"session-settings-tags-data" }}
{% endif %}
{% if sessionQuestions %}
    {{sessionQuestions|json_script:"session-questions"}}
{% endif %}
{{ availableTags|json_script:"available-tags-data"}}
<script>
    const csrfToken = document.querySelector('meta[name=csrf_token]').getAttribute('content');

    const sessionTags = document.getElementById('session-tags');
    const availableTags = document.getElementById('available-tags');

    const saveButton = document.getElementById('save-button');

    const sessionTitleData = document.getElementById('session-title');

    const modalBackdrop = document.getElementById('modal-backdrop');
    const deleteSessionSettingsBtn = document.getElementById('delete-session-settings');
    const deleteSessionSettingsModal = document.getElementById('delete-session-settings-confirm');
    const cancelDeleteSessionSettings = document.getElementById('cancel-delete-session-settings');

    const deleteTagConfirmModal = document.getElementById('delete-tag-confirm');
    const cancelTagDelete = document.getElementById('cancel-tag-delete');
    const confirmTagDeleteBtn = document.getElementById('confirm-tag-delete');

    const newTagModal = document.getElementById('new-tag-modal');
    const createTag = document.getElementById('create-tag')
    const createTagBtn = document.getElementById('confirm-create-tag');
    const newTagName = document.getElementById('tag-name');

    const startSession = document.getElementById('start-session');
    
    const exclusiveBtn = document.getElementById('exclusive');

    const selectAll = document.getElementById('select-all');
    const deselectAll = document.getElementById('deselect-all');

    const availableTagsSearch = document.getElementById('available-tags-search');
    const sessionTagsSearch = document.getElementById('session-tags-search');

    const clearSessionTagSearch = document.getElementById("clear-session-tag-search");
    const clearAvailableTagSearch = document.getElementById('clear-available-tag-search');

    const sessionQuestions = JSON.parse(document.getElementById('session-questions').textContent);

    const selectedQuestions = document.getElementById('selected-questions');
    const questionTypeSelection = document.getElementById("question-type-selection");
    let questionValues = [];

    if(sessionQuestions){
        questionValues = sessionQuestions.slice()
    } else {
        questionValues = defaultQuestionList.slice();
    }

    let stagedTags = [];
    let isExclusive = "{{ sessionSettings.isExclusive|yesno:'true,false' }}" === 'true' || false ;
    const boardId = "{{ board.id }}";
    let sessionSettingsId = "{{ sessionSettings.id }}";
    let counter = 0;


    function createTagButton(tag, isSessionTag = false) {
        counter +=1;
        console.log(counter);
            const button = document.createElement('button');
            button.className = isSessionTag ? 'sessionTag text-center bg-gray-700 text-white rounded-2xl hover:shadow-[0_0px_15px_rgba(0,0,0,0.9)] hover:shadow-purple-900 hover:bg-gray-800 rounded-2xl w-full h-8 relative'
                                            : 'availableTag text-center bg-gray-700 text-white rounded-2xl hover:shadow-[0_0px_15px_rgba(0,0,0,0.9)] hover:shadow-purple-900 hover:bg-gray-800 rounded-2xl w-full h-8 relative';
            button.dataset.id = tag.id;
            button.textContent = tag.name;

            const removeTagButton = document.createElement('button');
            removeTagButton.textContent = 'X';
            removeTagButton.className = 'absolute right-2 top-2 bg-red-500 text-white text-xs px-1 rounded';
            removeTagButton.onclick = (e) => { 
                e.stopPropagation();
                openConfirmTagDeleteModal(tag.id);
            }

            button.appendChild(removeTagButton);

            return button;
    }

    function openNewTagModal() {
        newTagModal.classList.remove('hidden');
        modalBackdrop.classList.remove('hidden');
    }

    function closeNewTagModal() {
        newTagModal.classList.add('hidden');
        modalBackdrop.classList.add('hidden');
    }

    function closeConfirmTagDeleteModal() {
        deleteTagConfirmModal.classList.add('hidden');
        modalBackdrop.classList.add('hidden');
        confirmTagDeleteBtn.dataset.tagId = '';
    }

    function openConfirmTagDeleteModal(tagId) {
        deleteTagConfirmModal.classList.remove('hidden');
        confirmTagDeleteBtn.dataset.tagId = tagId;
        modalBackdrop.classList.remove('hidden');
    }

    function checkTitle(sessionTitle) {
        let canProceed = true;
        if (sessionTitle === '' || sessionTitle === 'Session Title') {
            sessionTitleData.classList.add('border-red-500', 'shadow-[0_0px_15px_rgba(0,0,0,0.9)]', 'shadow-red-500', 'focus:shadow-red-500', 'focus:border-red-500');
            canProceed = false;
        }
        return canProceed;
    }

    function checkQuestion() {
        let canProceed = true;
         if (questionValues.length < 1){
            questionTypeSelection.classList.add('border-red-500', 'shadow-[0_0px_15px_rgba(0,0,0,0.9)]', 'shadow-red-500', 'focus:shadow-red-500', 'focus:border-red-500');
            canProceed = false;
        }
        return canProceed;
    }
 
    cancelTagDelete.addEventListener('click', () => {
        closeConfirmTagDeleteModal();
    });

    exclusiveBtn.addEventListener('click', () => {
        if(!isExclusive){
            isExclusive = true;
            exclusiveBtn.classList.remove('bg-gray-600', 'text-green-300');
            exclusiveBtn.classList.add('bg-green-600','text-gray-700', 'hover:text-gray-950');
        } else {
            isExclusive = false;
           exclusiveBtn.classList.remove('bg-green-600', 'text-gray-700', 'hover:text-gray-950');
            exclusiveBtn.classList.add('bg-gray-600', 'text-green-300');
        }
    });

    clearAvailableTagSearch.addEventListener('click', () => {
        availableTagsSearch.value = '';
        availableTagsSearch.dispatchEvent(new Event('input', {bubbles: true }));
    });

    clearSessionTagSearch.addEventListener('click', () => {
        sessionTagsSearch.value = '';
        sessionTagsSearch.dispatchEvent(new Event('input', {bubbles: true }));
    });

    modalBackdrop.addEventListener('click', (e) => {
        modalBackdrop.classList.add('hidden');
        if(deleteSessionSettingsModal) {deleteSessionSettingsModal.classList.add('hidden');}
        if(newTagModal) {newTagModal.classList.add('hidden');}
        if(deleteTagConfirmModal){deleteTagConfirmModal.classList.add('hidden');}
    });

    newTagModal.addEventListener('click', (e) => {
        e.stopPropagation();
    });

    if(sessionSettingsId){
        deleteSessionSettingsBtn.addEventListener('click', (e) => {
            modalBackdrop.classList.remove('hidden');
            deleteSessionSettingsModal.classList.remove('hidden');
        })
        cancelDeleteSessionSettings.addEventListener('click', (e) => {
            deleteSessionSettingsModal.classList.add('hidden');
            modalBackdrop.classList.add('hidden');
        });
    }

    sessionTagsSearch.addEventListener('input', (e) => { 
        const sessionTagBtns = document.querySelectorAll('.sessionTag');
        sessionTagBtns.forEach(btn => {
            if(!btn.textContent.toLowerCase().startsWith(e.target.value.toLowerCase())) {
                btn.classList.add('hidden'); 
            } else {
                btn.classList.remove('hidden');  
            }
        });
    });

    availableTagsSearch.addEventListener('input', (e) => {
        const availableTagBtns = document.querySelectorAll('.availableTag');
        availableTagBtns.forEach(btn => {
            if(!btn.textContent.toLowerCase().startsWith(e.target.value.toLowerCase())) {
                btn.classList.add('hidden');    
            } else {
                btn.classList.remove('hidden');  
            }
        });
    });

    // Closes the delete modal popup
    cancelTagDelete.addEventListener('click', () => {
        deleteTagConfirm.classList.add('hidden');
        modalBackdrop.classList.add('hidden');
    });

    createTag.addEventListener('click', () => {
        newTagModal.classList.remove('hidden');
        modalBackdrop.classList.remove('hidden');
    });

    function startSessionFunc(){
        const sessionBtns = document.querySelectorAll('.sessionTag');
        let addTags = Array.from(sessionBtns).map(btn => btn.dataset.id);
        if(checkQuestion()) {
            questionTypeSelection.classList.remove('border-red-500', 'shadow-[0_0px_15px_rgba(0,0,0,0.9)]', 'shadow-red-500', 'focus:shadow-red-500', 'focus:border-red-500');
            fetch(`/board/${boardId}/sessions/sessionStart/`, {
                method : 'POST',
                headers : {
                    'X-CSRFToken' :csrfToken,
                    'Content-Type' : 'application/json'
                },
                body : JSON.stringify({ tags : addTags, isExclusive : isExclusive, questions : questionValues })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    window.location.href = data.redirect_url;
                } else {
                    alert('Failed');
                }
            })
        }
    }
   
    createTagBtn.addEventListener('click', () => {
            fetch(`/board/${boardId}/tags/createTag/`, {
                method : 'POST',
                headers : {
                    'X-CSRFToken' : csrfToken,
                    'Content-Type' : 'application/json'
                },
                body : JSON.stringify({name : newTagName.value })
            })
            .then(res => res.json())
            .then(data => {
                console.log('Added Tag', data);
                availableTags.append(createTagButton(data, false));
                newTagName.value = '';
                closeNewTagModal();
            })
            .catch(err => console.error('Tag Failed', err));
    });
    

    // Event listener to handle fully deleting a tag after confirm delete popup
    confirmTagDeleteBtn.addEventListener('click', () => {
        const tagId = confirmTagDeleteBtn.dataset.tagId;
        if(!tagId) return;
            fetch(`/tag/${tagId}/delete/`, {
                method: 'POST',
                headers: { 'X-CSRFToken' : csrfToken }
            })
            .then(res => res.json())
            .then(data => {
                if(data.success) {
                    document.querySelector(`[data-id="${tagId}"]`)?.remove();
                    closeConfirmTagDeleteModal();
                } else {
                    alert('Failed to delete tag: ' + data.error);
                }
            });
    });

    saveButton.addEventListener('click', () => {
        const sessionTitle = sessionTitleData.value.trim() || sessionTitleData.placeholder.trim();

        if(checkQuestion){ questionTypeSelection.classList.remove('border-red-500', 'shadow-[0_0px_15px_rgba(0,0,0,0.9)]', 'shadow-red-500', 'focus:shadow-red-500', 'focus:border-red-500'); } 
        if(checkTitle(sessionTitle)) { sessionTitleData.classList.remove('border-red-500', 'shadow-[0_0px_15px_rgba(0,0,0,0.9)]', 'shadow-red-500', 'focus:shadow-red-500', 'focus:border-red-500'); }

        if(checkQuestion() && checkTitle(sessionTitle)) {
            let fetchLink = '';
            if(sessionSettingsId){
                fetchLink = `/board/${boardId}/sessions/${sessionSettingsId}/update/`;
            } else {
                fetchLink = `/board/${boardId}/sessions/newSessionSettings/`;
            }
            fetch(fetchLink, {
                method : 'POST',
                headers : {
                    'X-CSRFToken' : csrfToken,
                    'Content-Type' : 'application/json'
                },
                body : JSON.stringify({title : sessionTitle, tags : stagedTags, isExclusive : isExclusive, questions : questionValues })
            })
            .then(res => res.json())
            .then(data => {
                sessionTitleData.placeholder = sessionTitle;
                sessionTitleData.value = sessionTitle;
                if(data.success) {
                    sessionSettingsId = data.sessionSettingsId;
                }
            })
            .catch(err => console.error('Submit Failed', err))
        }
    });

    selectAll.addEventListener('click', () => {
        const buttons = document.querySelectorAll('.availableTag');
        buttons.forEach(btn => {
            stagedTags.push(btn.dataset.id);
            btn.classList.toggle('sessionTag');
            btn.classList.toggle('availableTag');
            sessionTags.append(btn);
        })
    });

    deselectAll.addEventListener('click', () => {
        const buttons = document.querySelectorAll('.sessionTag');
        buttons.forEach(btn => {
            stagedTags.pop(btn.dataset.id);
            btn.classList.toggle('sessionTag');
            btn.classList.toggle('availableTag');
            availableTags.append(btn);
        })
    });

    document.addEventListener('click', (e) => {
        if(e.target.classList.contains('sessionTag') || e.target.classList.contains('availableTag')) {
            const button = e.target.closest('button');
            const tagId = button.dataset.id;
            const isSessionTag = button.classList.contains('sessionTag');

            if(!isSessionTag){
                stagedTags.push(tagId);
            } else {
                stagedTags = stagedTags.filter(id => id !== tagId);
            }

            button.classList.toggle('sessionTag');
            button.classList.toggle('availableTag');
            const parent = button.parentElement.id === 'session-tags' ? availableTags : sessionTags;
            parent.appendChild(button);
        }
    });

    // Used to dynamically load tag button when the dom is loaded, easy to implement deletion button methodology compared to an html forloop 
    document.addEventListener('DOMContentLoaded', () => {
        const availableTagsData = JSON.parse(document.getElementById('available-tags-data').textContent);
        // Honestly no clue why I couldn't parse this but these questions are the only choice now so this works great
        const defaultQuestionList = ['answer', 'true_or_false', 'definition', 'multiple_choice'];
        
        availableTags.innerHTML = '';
        availableTagsData.forEach(tag => {
            availableTags.appendChild(createTagButton(tag, false));
        });

        defaultQuestionList.forEach(question => {
            const newValue = document.createElement('button');
            newValue.classList.add('bg-gray-700', 'text-sm', 'w-full', 'rounded-xl', 'py-1', 'lg:text-xl', 'text-white', 'font-bold', 'text-center', 'border-3', 'border-transparent', 'hover:shadow-[0_0px_8px_rgba(0,0,0,0.9)]', 'hover:shadow-blue-500');
            newValue.dataset.title=question;
            newValue.innerText = `${question.split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ')}`
            if(questionValues.includes(question)){
                newValue.classList.add('border-blue-500');
                newValue.classList.remove('text-white');
                newValue.classList.add('text-blue-300');
            }
            newValue.addEventListener('click', () => {
                if(questionValues.includes(question)) {
                    questionValues.splice(questionValues.indexOf(question), 1);
                    newValue.classList.remove('border-blue-500');
                    newValue.classList.remove('text-blue-300');
                    newValue.classList.add('text-white'); 
                } else {
                    questionValues.push(question);
                    newValue.classList.add('border-blue-500');
                    newValue.classList.remove('text-white');
                    newValue.classList.add('text-blue-300');
                }
                console.log(questionValues);
            });
            selectedQuestions.appendChild(newValue)
        });

        try { 
            const sessionSettingsTagsData = JSON.parse(document.getElementById('session-settings-tags-data').textContent);
            sessionTags.innerHTML = '';
            if(sessionSettingsTagsData) {
                sessionSettingsTagsData.forEach(tag => {
                    sessionTags.appendChild(createTagButton(tag, true))
                    stagedTags.push(tag.id)
                });
            }
        } catch(error){}
    });
</script>
{% endblock %}