<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!--Site Title and Icon-->
    <link rel="icon" type="image/x-icon" href="/static/icons/LearningLogsLogo.png">
    <title>Learning Logs</title>

        <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>


    <style>
        html, body{
            height: 100%
        }
    </style>

    {% load static tailwind_tags %}
</head>
<body class="bg-gray-900"> 
{% if user.is_authenticated %}
    <header class="bg-gray-800 py-1 rounded-2xl fixed top-2 left-4 right-4 z-30">
        <nav class="flex justify-between items-center w-full mx-auto">
            <div class="flex items-center gap-4 pl-4">
                <a href="{% url 'dashboard' %}">
                    <img src="{% static 'icons/LearningLogsLogo.png' %}" class="h-14 w-14 object-contain">
                </a>
                <a href="{% url 'dashboard' %}">
                    <h1 class="text-2xl text-purple-400 hover:text-purple-700 font-bold">My Boards</h1>
                </a>
                {% if board %}
                    <a href="{% url 'boardPage' board.id %}">
                        <h1 class="text-2xl text-purple-400 hover:text-purple-700 font-bold">{{ board.title }}</h1>
                    </a>
                    <a href="{% url 'newSessionSettings' board.id %}">
                        <h1 class="text-2xl text-purple-400 hover:text-purple-700 font-bold">Study</h1>
                    </a>
                {% endif %}
            </div>
            <div class="flex items-center gap-4 pr-4">
                {% if board %}
                    <button id="open-board-settings-modal" class="text-2xl text-purple-400 hover:text-purple-900 font-bold">Board Settings</button>
                {% endif %}
                <div class="relative inline-block text-left">
                    <img id="profile-button" src="{% static 'icons/placeholderProfile.png' %}" class="h-10 w-10 object-contain rounded-2xl hover:cursor-pointer">
                    
                    <div id="profile-dropdown" class="origin-top-right absolute right-0 mt-2 w-56 rounded-md bg-gray-800 shadow-lg hidden">
                        <div class="py-1">
                            {% if board %}
                                <a href="#" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700">Board Settings</a>
                            {% endif %}
                            {% if user.is_authenticated %}
                            <form method="post" action="{% url 'logout' %}">
                                {% csrf_token %}
                                <button type="submit" class="px-4 py-2 text-sm text-gray-300 hover:bg-gray-700 block w-full text-left">Sign Out</button>
                            </form>
                            {% else %}
                            <a href="{% url 'signIn' %}" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700">Sign In</a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </nav>
    </header>
    <!--Background wrapper to make bg blurry when choosing which settings to load-->
    <div id="base-modal-backdrop" class="hidden fixed inset-0 z-[1000] bg-black/50 backdrop-blur-sm"></div>
    {% if board %}
        <!--Board Settings Modal-->
        <div id="board-settings-modal" class="hidden fixed inset-x-96 inset-y-20 mt-10 z-[1001] p-3 bg-gray-800 rounded-2xl shadow-md shadow-black">
            <div class="h-full w-full flex flex-col align-items-center">
                <div class="h-[95%] w-full flex flex-col align-items-center gap-y-12 ">
                    <h2 class="text-purple-400 text-5xl font-bold">Board Settings</h2>
                    <div class="flex flex-row w-[95%] h-fit gap-x-6 align-items-center">
                        <h2 class="text-white text-2xl font-bold w-[30%]">Default Questions</h2>
                        <div id="default-questions" class="flex flex-row gap-x-2 w-full">
                        </div>
                    </div>
                </div>
                <div class="w-full h-fit justify-content-center flex flex-row gap-x-4">
                    <button id="save-board-settings-button" class="px-10 py-1 bg-gray-600 rounded text-2xl text-white font-bold hover:bg-gray-700 hover:shadow-[0_0px_15px_rgba(0,0,0,0.9)] hover:shadow-blue-500">Save</button>
                    <button id="cancel-board-settings-button" class="px-10 py-1 bg-gray-600 rounded text-2xl text-white font-bold hover:bg-gray-700 hover:shadow-[0_0px_15px_rgba(0,0,0,0.9)] hover:shadow-red-500">Cancel</button>
                </div>            
            </div>
        </div>
{% endif %}
    {% endif %}
    {% block content%}
    {% endblock %}

        <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
        <!--Fitty to help text sizing-->
    <script src="https://unpkg.com/fitty/dist/fitty.min.js"></script>
    <script>
        const baseBoardId = "{{ board.id }}" || null;
        const profileButton = document.getElementById("profile-button");
        const profileDropdown = document.getElementById('profile-dropdown');
        const baseModalBackdrop = document.getElementById('base-modal-backdrop');


        profileButton.addEventListener('click', () => {
            profileDropdown.classList.toggle('hidden');
        });

        window.addEventListener('click', function(e){
            if(!profileButton.contains(e.target) && !profileDropdown.contains(e.target)){
                profileDropdown.classList.add('hidden');
            }
        });

        function SignOut(){
        }

        if(baseBoardId){
            const defaultQuestionsrow = document.getElementById('default-questions');
            const saveBoardSettingsBtn = document.getElementById('save-board-settings-button');
            const boardSettingsModal = document.getElementById('board-settings-modal');
            const openBoardSettingsModal = document.getElementById('open-board-settings-modal');
            const cancelBoardSettings = document.getElementById('cancel-board-settings-button');
            let boardDefaultQuestions = [];
            let stagedQuestions = [];
            cancelBoardSettings.addEventListener('click', () => {
                boardSettingsModal.classList.add('hidden');
                baseModalBackdrop.classList.add('hidden');
            });

            

            baseModalBackdrop.addEventListener('click', () => {
                if(!baseModalBackdrop.classList.contains('hidden') ){
                    baseModalBackdrop.classList.add('hidden');
                    boardSettingsModal.classList.add('hidden');
                }
                if(!boardSettingsModal.classList.contains('hidden')) {
                    boardSettingsModal.classList.add('hidden');
                }
            });

            openBoardSettingsModal.addEventListener('click', () => {
                if(baseModalBackdrop.classList.contains('hidden')) {
                    baseModalBackdrop.classList.remove('hidden');
                    boardSettingsModal.classList.remove('hidden');
                    stagedQuestions = [...boardDefaultQuestions];
                    document.querySelectorAll('.settings-btn').forEach(btn => {
                        if(stagedQuestions.includes(btn.dataset.title)) {
                            btn.classList.remove('text-white', 'border-transparent');
                            btn.classList.add('text-purple-200', 'border-purple-600');
                        } else {
                            btn.classList.remove('text-purple-200', 'border-purple-600');
                            btn.classList.add('text-white', 'border-transparent');
                        }
                    });
                } else {
                    baseModalBackdrop.classList.add('hidden');
                    boardSettingsModal.classList.add('hidden');
                }
            })

            document.addEventListener('DOMContentLoaded', () => {
                    boardDefaultQuestions = [];
                    let baseQuestions = [];
                    fetch(`/api/${baseBoardId}/all-questions/`)
                    .then(res => res.json())
                    .then(data => {
                        baseQuestions = [...data.baseQuestions];
                        boardDefaultQuestions =[...data.boardDefaultQuestions];
                        stagedQuestions = [...data.boardDefaultQuestions];
                    baseQuestions.forEach(question => {
                        const btn = document.createElement('button');
                        btn.dataset.title = question;
                        btn.innerText = `${question.split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ')}` ;
                        btn.classList.add('settings-btn', 'bg-gray-500', 'w-full', 'h-fit', 'text-xl', 'text-white', 'font-bold', 'py-2', 'rounded', 'border-3', 'border-transparent', 'hover:bg-gray-600', 'hover:shadow-[0_0px_15px_rgba(0,0,0,0.9)]', 'hover:shadow-purple-500')
                        if(boardDefaultQuestions.includes(question)) {
                            btn.classList.remove('text-white', 'border-transparent');
                            btn.classList.add('text-purple-200', 'border-purple-600')
                        }
                        btn.addEventListener('click', () => {
                            if(stagedQuestions.includes(question)){
                                stagedQuestions.splice(stagedQuestions.indexOf(question), 1);
                                btn.classList.add('text-white', 'border-transparent');
                                btn.classList.remove('text-purple-200', 'border-purple-600');
                            } else {
                                stagedQuestions.push(question);
                                btn.classList.remove('text-white', 'border-transparent');
                                btn.classList.add('text-purple-200', 'border-purple-600');
                            }
                            console.log(stagedQuestions);
                        });
                        defaultQuestionsrow.appendChild(btn);
                    });
                    saveBoardSettingsBtn.addEventListener('click', () => {
                        console.log(stagedQuestions)
                        fetch(`/board/${baseBoardId}/saveSettings/`, {
                            method : 'POST',
                            headers : {
                                'X-CSRFToken' : csrfToken,
                                'Content-Type' : 'application/json'
                            },
                            body : JSON.stringify({ defaultQuestions : stagedQuestions })
                        })
                        .then(res => res.json())
                        .then(data => {
                            if(data.success){
                                console.log('Saved Board');
                                boardSettingsModal.classList.add('hidden');
                                baseModalBackdrop.classList.add('hidden');
                                stagedQuestions = [...data.questions];
                                boardDefaultQuestions = [...stagedQuestions]
                                baseQuestions.forEach(question => {
                                    const btn = document.querySelector(`[data-title="${question}"]`) 
                                    if(stagedQuestions.includes(question)) {
                                        btn.classList.remove('text-white', 'border-transparent');
                                        btn.classList.add('text-purple-200', 'border-purple-600')
                                    } else {
                                        btn.classList.add('text-white', 'border-transparent');
                                        btn.classList.remove('text-purple-200', 'border-purple-600')
                                    }
                                });
                            }
                        }).catch(err => {console.error('error', err)})
                    });

                    });

                    

            })
    }


    </script>
</body>
</html>

