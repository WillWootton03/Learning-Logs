<!DOCTYPE html>
<html class="m-0 bg-gray-900"  lang="en">
<head>
    {% load static tailwind_tags %}
    <!--Tailwind for vercel-->
    <link href="{% static 'css/dist/styles.css' %}" rel="stylesheet">
    <link rel="icon" type="image/x-icon" href="{% static 'favicon.ico' %}">
    <link rel="shortcut icon" href="{% static 'favicon.ico' %}">
    <meta charset="UTF-8">
    <!--Site Title and Icon-->
    <title>Learning Logs</title>
    
    <style>
        html, body{
            height: 100%
        }
    </style>
    
</head>
{% if user.is_authenticated %}
    <header class="bg-gray-800 py-1 rounded-2xl fixed top-2 left-0 right-0 md:left-4 md:right-4 z-30 shadow-md shadow-black">
        <nav class="flex justify-between items-center w-full">
            <div class="flex items-center gap-x-2 md:gap-x-4 pl-4">
                <a id="ll-icon" href="{% url 'dashboard' %}" class="hidden md:inline-block">
                    <img src="{% static 'favicon.ico' %}" class="h-14 w-14 object-contain drop-shadow-md drop-shadow-black">
                </a>
                <a href="{% url 'dashboard' %}">
                    <h1 class="text-sm sm:text-xl md:text-2xl lg:text-3xl text-purple-400 hover:text-purple-700 font-bold drop-shadow-md drop-shadow-black transition-color-fontsize">My Boards</h1>
                </a>
                {% if board %}
                    <a href="{% url 'boardPage' board.id %}">
                        <h1 class="text-sm sm:text-xl  md:text-2xl lg:text-3xl text-purple-400 hover:text-purple-700 font-bold drop-shadow-md drop-shadow-black transition-color-fontsize">{{ board.title }}</h1>
                    </a>
                    <a href="{% url 'newSessionSettings' board.id %}">
                        <h1 class="text-sm sm:text-xl  md:text-2xl lg:text-3xl text-purple-400 hover:text-purple-700 font-bold drop-shadow-md drop-shadow-black transition-color-fontsize">Study</h1>
                    </a>
                {% else %}
                <a href="{% url 'newBoard' %}">
                        <h1 class="text-sm sm:text-xl  md:text-2xl lg:text-3xl text-purple-400 hover:text-purple-700 font-bold drop-shadow-md drop-shadow-black transition-color-fontsize ">New Board</h1>
                    </a>
                {% endif %}
            </div>
            <div class="flex items-center gap-x-4 md:gap-x-8 pr-4">
                {% if board %}
                    <button id="open-board-settings-modal" class="text-sm md:text-2xl lg:text-3xl text-purple-400 drop-shadow-md drop-shadow-black hover:text-purple-900 font-bold transition-color-fontsize">Board Settings</button>
                {% endif %}
                <div class="relative inline-block text-left">
                    <img id="profile-button" src="{% static 'icons/placeholderProfile.png' %}" class="h-10 w-10 object-contain rounded-2xl hover:cursor-pointer drop-shadow-md drop-shadow-black">
                    
                    <div id="profile-dropdown" class="origin-top-right absolute right-0 mt-2 w-56 rounded-md bg-gray-800 shadow-lg hidden">
                        <div class="py-1">
                            {% if user.is_authenticated %}
                            <form method="post" action="{% url 'logout' %}">
                                {% csrf_token %}
                                <button type="submit" class="px-4 py-2 text-sm text-gray-300 hover:bg-gray-700 block w-full text-left">Sign Out</button>
                            </form>
                            {% else %}
                            <a href="{% url 'signIn' %}" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700">Sign In</a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </nav>
    </header>
    <!--Background wrapper to make bg blurry when choosing which settings to load-->
    {% if board %}
    <div id="base-modal-backdrop" class="hidden h-full w-full fixed flex items-center justify-center inset-0 z-[1000] bg-black/50 backdrop-blur-sm">
        <!--Board Settings Modal-->
        <div id="board-settings-modal" class="hidden h-fit w-fit z-[1001] flex items-center justify-center">
            <div class="py-2 bg-gray-800 rounded-2xl px-5 shadow-md shadow-black flex flex-col items-center gap-y-10">
                <div class="h-[95%] w-fit flex flex-col items-center gap-y-12 ">
                    <h2 class="text-purple-400 text-5xl font-bold">Board Settings</h2>
                    <div class="flex flex-col md:flex-row w-full h-fit items-center">
                        <h2 class="text-white text-2xl font-bold flex-2">Default Questions</h2>
                        <div id="default-questions" class="grid grid-cols-2 gap-y-2 grid-rows-2 lg:flex lg:flex-row flex-7 gap-x-2 w-full">
                        </div>
                    </div>
                </div>
                <div class="w-full h-fit justify-center flex flex-row gap-x-4">
                    <button id="save-board-settings-button" class="px-10 py-1 bg-gray-600 rounded text-2xl text-white font-bold hover:bg-gray-700 hover:shadow-[0_0px_15px_rgba(0,0,0,0.9)] hover:shadow-blue-500">Save</button>
                    <button id="cancel-board-settings-button" class="px-10 py-1 bg-gray-600 rounded text-2xl text-white font-bold hover:bg-gray-700 hover:shadow-[0_0px_15px_rgba(0,0,0,0.9)] hover:shadow-red-500">Cancel</button>
                </div>            
            </div>
        </div>
    </div>
    {% endif %}
{% endif %}
    {% block content%}
    {% endblock %}

        <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
        <!--Fitty to help text sizing-->
    <script src="https://unpkg.com/fitty/dist/fitty.min.js"></script>
    <script>
        const baseBoardId = "{{ board.id }}" || null;
        const profileButton = document.getElementById("profile-button");
        const profileDropdown = document.getElementById('profile-dropdown');
        const baseModalBackdrop = document.getElementById('base-modal-backdrop');


        profileButton.addEventListener('click', () => {
            profileDropdown.classList.toggle('hidden');
        });

        window.addEventListener('click', function(e){
            if(!profileButton.contains(e.target) && !profileDropdown.contains(e.target)){
                profileDropdown.classList.add('hidden');
            }
        });


        if(baseBoardId){
            const defaultQuestionsrow = document.getElementById('default-questions');
            const saveBoardSettingsBtn = document.getElementById('save-board-settings-button');
            const boardSettingsModal = document.getElementById('board-settings-modal');
            const openBoardSettingsModal = document.getElementById('open-board-settings-modal');
            const cancelBoardSettings = document.getElementById('cancel-board-settings-button');
            let boardDefaultQuestions = [];
            let stagedQuestions = [];
            cancelBoardSettings.addEventListener('click', () => {
                boardSettingsModal.classList.add('hidden');
                baseModalBackdrop.classList.add('hidden');
            });


            baseModalBackdrop.addEventListener('click', () => {
                if(!baseModalBackdrop.classList.contains('hidden') ){
                    baseModalBackdrop.classList.add('hidden');
                    boardSettingsModal.classList.add('hidden');
                }
                if(!boardSettingsModal.classList.contains('hidden')) {
                    boardSettingsModal.classList.add('hidden');
                }
            });

            boardSettingsModal.addEventListener('click', (e) => {
                e.stopPropagation();
            });

            openBoardSettingsModal.addEventListener('click', (e) => {
                e.stopPropagation();
                if(baseModalBackdrop.classList.contains('hidden')) {
                    baseModalBackdrop.classList.remove('hidden');
                    boardSettingsModal.classList.remove('hidden');
                    stagedQuestions = [...boardDefaultQuestions];
                    document.querySelectorAll('.settings-btn').forEach(btn => {
                        if(stagedQuestions.includes(btn.dataset.title)) {
                            btn.classList.remove('text-white', 'border-transparent');
                            btn.classList.add('text-purple-200', 'border-purple-600');
                        } else {
                            btn.classList.remove('text-purple-200', 'border-purple-600');
                            btn.classList.add('text-white', 'border-transparent');
                        }
                    });
                } else {
                    baseModalBackdrop.classList.add('hidden');
                    boardSettingsModal.classList.add('hidden');
                }
            })

            document.addEventListener('DOMContentLoaded', () => {
                    boardDefaultQuestions = [];
                    let baseQuestions = [];
                    fetch(`/api/${baseBoardId}/all-questions/`)
                    .then(res => res.json())
                    .then(data => {
                        baseQuestions = [...data.baseQuestions];
                        boardDefaultQuestions =[...data.boardDefaultQuestions];
                        stagedQuestions = [...data.boardDefaultQuestions];
                    baseQuestions.forEach(question => {
                        const btn = document.createElement('button');
                        btn.dataset.title = question;
                        btn.innerText = `${question.split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ')}` ;
                        btn.classList.add('settings-btn', 'px-4', 'bg-gray-500', 'h-fit', 'text-md', 'md:text-xl', 'text-white', 'font-bold', 'py-2', 'rounded', 'border-3', 'border-transparent', 'hover:bg-gray-600', 'hover:shadow-[0_0px_15px_rgba(0,0,0,0.9)]', 'hover:shadow-purple-500')
                        if(boardDefaultQuestions.includes(question)) {
                            btn.classList.remove('text-white', 'border-transparent');
                            btn.classList.add('text-purple-200', 'border-purple-600')
                        }
                        btn.addEventListener('click', () => {
                            if(stagedQuestions.includes(question)){
                                stagedQuestions.splice(stagedQuestions.indexOf(question), 1);
                                btn.classList.add('text-white', 'border-transparent');
                                btn.classList.remove('text-purple-200', 'border-purple-600');
                            } else {
                                stagedQuestions.push(question);
                                btn.classList.remove('text-white', 'border-transparent');
                                btn.classList.add('text-purple-200', 'border-purple-600');
                            }
                        });
                        defaultQuestionsrow.appendChild(btn);
                    });
                    saveBoardSettingsBtn.addEventListener('click', () => {
                        fetch(`/board/${baseBoardId}/saveSettings/`, {
                            method : 'POST',
                            headers : {
                                'X-CSRFToken' : csrfToken,
                                'Content-Type' : 'application/json'
                            },
                            body : JSON.stringify({ defaultQuestions : stagedQuestions })
                        })
                        .then(res => res.json())
                        .then(data => {
                            if(data.success){
                                console.log('Saved Board');
                                boardSettingsModal.classList.add('hidden');
                                baseModalBackdrop.classList.add('hidden');
                                stagedQuestions = [...data.questions];
                                boardDefaultQuestions = [...stagedQuestions]
                                baseQuestions.forEach(question => {
                                    const btn = document.querySelector(`[data-title="${question}"]`) 
                                    if(stagedQuestions.includes(question)) {
                                        btn.classList.remove('text-white', 'border-transparent');
                                        btn.classList.add('text-purple-200', 'border-purple-600')
                                    } else {
                                        btn.classList.add('text-white', 'border-transparent');
                                        btn.classList.remove('text-purple-200', 'border-purple-600')
                                    }
                                });
                            }
                        }).catch(err => {console.error('error', err)})
                    });

                    });

                    

            })
    }


    </script>
</body>
</html>

