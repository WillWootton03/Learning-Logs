{% extends 'base.html' %}
{% load static tailwind_tags %}

{% block content %}
    <meta name="csrf_token" content="{{ csrf_token }}">

    <div class="flex flex-box mx-5 pt-24 h-[calc(100vh-3rem)]">
        <!--Left and right seperator-->
        <div class="flex flex-col transition-all duration-200 lg:grid lg:grid-cols-[1fr_2fr] grid-rows-2 gap-x-10 gap-y-10 w-full h-full">
            <!--Is the small card for Logs-->
            <div class="w-full flex flex-col pt-2 pb-4 items-center bg-gray-700 rounded-xl relative shadow-md shadow-black hover:shadow-[0_0px_15px_rgba(0,0,0,0.9)] hover:shadow-purple-700">
                <div class="text-3xl font-bold mt-2 mb-4 text-center text-white cursor-default drop-shadow-[0_2px_6px_rgba(0,0,0,0.9)]">My Logs</div>
                <div class="w-full h-40 lg:h-full overflow-y-auto items-center flex flex-col gap-y-3">
                    {% for log in logs %}
                        <a href="{% url 'logBreakdown' log.id %}" class="bg-gray-600 w-[90%] h-14 rounded flex flex-row items-center shadow-black shadow-md hover:bg-gray-800">
                            <p class="truncate text-left font-medium text-white px-4 flex-1">{{ log.title }}</p>
                            <p class="text-right px-4 font-medium text-white flex-3">
                                <span class='local-time' data-time="{{ log.dateAdded|date:'c' }}"></span>
                            </p>
                        </a>
                    {% endfor %}
                </div>
                <a href="{% url 'newLog' board.id %}" class="absolute top-2 right-2 bg-purple-500 text-black rounded-full px-3.5 py-2 shadow-md shadow-black hover:bg-purple-700">+</a>
            </div>

            <!--Is the large card for Learning Breakdown-->
            <div class="w-full flex flex-col pt-2 pb-4 items-center bg-gray-700 rounded-xl relative shadow-md shadow-black hover:shadow-[0_0px_15px_rgba(0,0,0,0.9)] hover:shadow-purple-700">
                <h2 class="text-3xl font-bold pb-5 text-white cursor-default drop-shadow-[0_2px_6px_rgba(0,0,0,0.9)]">My Learning Breakdown</h2>
                <div class="flex flex-col md:flex-row gap-y-3 w-full gap-x-2 md:gap-x-12 px-2 md:px-10 h-[80%]">
                    <!--Div for the learning breakdown graph-->
                    <div class="bg-gray-500 px-3 py-2 rounded-2xl shadow-md shadow-black h-full flex-1 flex flex-col gap-y-2">
                        <h2 class="text-center text-lg xl:text-2xl font-bold text-black cursor-default">Graph Breakdown</h2>
                        <img src="{{ chart }}" class="w-full h-[80%] object-contain" alt="Chart">
                    </div>
                    <!--Section for known concepts-->
                    <div class="bg-gray-500 h-full flex-2 flex flex-col rounded-2xl justify-center items-center py-4 gap-y-5 lg:gap-y-4">
                        <div class="h-fill py-2 md:py-0 px-2 md:rounded-lg rounded-2xl w-[90%] bg-gray-800 flex flex-row items-center justify-between shadow-md shadow-black">
                            <h2 class="text-lg md:text-2xl font-bold px-4 text-left text-white cursor-default transition-all duration-200">Known Concepts </h2>
                            <h2 class="text-lg md:text-2xl font-bold px-4 text-right text-white cursor-default transition-all duration-200">{{ knownConceptsCount }}</h2>
                        </div>
                        <div class="h-fill py-2 md:py-0 px-2 md:rounded-lg rounded-2xl w-[90%] bg-gray-800 flex items-center justify-between shadow-md shadow-black">
                            <h2 class="text-lg md:text-2xl font-bold px-4 text-left text-white cursor-default transition-all duration-200">Learning Concepts</h2>
                            <h2 class="text-lg md:text-2xl font-bold px-4 text-right text-white cursor-default transition-all duration-200">{{ learningConceptsCount }}</h2>
                        </div>
                        <div class="h-fill py-2 md:py-0 px-2 md:rounded-lg rounded-2xl w-[90%] bg-gray-800 flex items-center justify-between shadow-md shadow-black">
                            <h2 class="text-lg md:text-2xl  text-white font-bold px-4 text-left cursor-default transition-all duration-200">Unknown Concepts</h2>
                            <h2 class="text-lg md:text-2xl text-white font-bold px-4 text-right cursor-default transition-all duration-200">{{ unknownConceptsCount }}</h2>
                        </div>
                    </div>
                </div>
            </div>

            <!--Is the small card for Study Sessions-->
            <div class="w-full flex flex-col bg-gray-700 rounded-2xl h-full relative shadow-md shadow-black hover:shadow-[0_0px_15px_rgba(0,0,0,0.9)] hover:shadow-purple-700">
                <h2 class="text-3xl font-bold mt-2 mb-4 text-center text-white cursor-default drop-shadow-[0_2px_6px_rgba(0,0,0,0.9)]">My Study Sessions</h2>
                <div class="w-full h-full flex flex-col gap-y-2 overflow-y-auto items-center auto-rows-min">
                {% for session in sessions %}
                    <div class="bg-purple-700 text-white cursor-default text-lg h-fit font-bold w-[90%] rounded flex justify-between items-center px-2 py-2">
                            <span class='local-time' data-time="{{ session.dateAdded|date:'c' }}"></span>
                        <div class="grid grid-cols-2 w-[30%] gap-x-2">
                            <p class="px-2 text-white bg-green-600 rounded text-center">{{ session.correctAnswers }}</p>
                            <p class="px-2 text-white bg-red-600 rounded text-center">{{ session.incorrectAnswers }}</p>
                        </div>
                        
                    </div>
                    {% endfor %}
                </div>
                <button id="toggle-sessions-settings" class="absolute top-2 right-2 bg-purple-500 text-black rounded-full px-3.5 py-2 shadow-md shadow-black hover:bg-purple-700">+</button>
                <div id="sessions-settings-dropdown" class="hidden absolute flex flex-col top-8 right-7 bg-gray-800 gap-y-2 py-2 px-2 w-fit h-fit rounded shadow-md shadow-black"> 
                    <a href="{% url 'newSessionSettings' board.id %}" class="bg-gray-600 px-2 py-1 text-white text-md font-bold rounded hover:shadow-[0_0px_15px_rgba(0,0,0,0.9)] hover:shadow-purple-700 hover:bg-gray-500">New Session Settings</a>
                    <button id="load-sessions-settings" class="bg-gray-600 px-2 py-1 text-white text-md font-bold rounded hover:shadow-[0_0px_15px_rgba(0,0,0,0.9)] hover:shadow-purple-700 hover:bg-gray-500">Load Session Settings</button>
                </div>
            </div>

            <!--Is the larger card for Concepts-->
            <div class="w-full h-full flex flex-col gap-y-3 bg-gray-700 rounded-2xl py-2 relative shadow-md shadow-black hover:shadow-[0_0px_15px_rgba(0,0,0,0.9)] hover:shadow-purple-700">
                <h2 class="text-3xl font-bold text-center text-white cursor-default drop-shadow-[0_2px_6px_rgba(0,0,0,0.9)] flex-1 flex justify-center ">My Concepts</h2>
                    <div class="h-fit w-full align-content-center px-4 flex flex-col md:flex-row gap-y-2 items-center justify-between md:justify-start gap-x-2">
                        <div class="flex flex-row flex-3 md:flex-4 gap-x-1 md:gap-x-3">
                            <button id="known-concepts-button" class="bg-gray-500 px-1 text-sm md:px-2 md:text-xl text-green-300 font-bold py-1 rounded hover:shadow-[0_0px_15px_rgba(0,0,0,0.9)] hover:shadow-green-500 hover:bg-gray-500 hover:text-green-500 active:border-green-500 border-4 border-transparent">Known</button>
                            <button id="learning-concepts-button" class="bg-gray-500 px-1 text-sm md:px-2 md:text-xl text-yellow-200 font-bold py-1 rounded hover:shadow-[0_0px_15px_rgba(0,0,0,0.9)] hover:shadow-yellow-400 hover:bg-gray-500 hover:text-yellow-300 active:border-yellow-500 border-4 border-transparent">Learning</button>
                            <button id="unknown-concepts-button" class="bg-gray-500 px-1 text-sm md:px-2 md:text-xl text-red-300 font-bold py-1 rounded hover:shadow-[0_0px_15px_rgba(0,0,0,0.9)] hover:shadow-red-500 hover:bg-gray-500 hover:text-red-500 active:border-red-500 border-4 border-transparent">Unknown</button>
                            <button id="clear-concepts-button" class="bg-gray-500 px-1 text-sm md:px-2 md:text-xl text-blue-300 font-bold py-1 rounded hover:shadow-[0_0px_15px_rgba(0,0,0,0.9)] hover:shadow-blue-500 hover:bg-gray-500 hover:text-blue-500 active:border-blue-500 border-4 border-transparent">Clear</button>
                        </div>
                        <input id="concept-search" placeholder="Search" class="text-md md:text-xl flex-2 text-center h-full bg-gray-500 text-white w-[30%] py-1 rounded md:justify-end" autocomplete="off"/>
                    </div>
                <button id="toggle-new-concept" class="bg-purple-500 absolute top-2 right-2 text-black rounded-full px-3.5 py-2 shadow-md shadow-black flex-7 hover:bg-purple-700">+</button>
                <div id="concept-grid" class="grid grid-cols-3 sm:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 w-full h-full auto-rows-min gap-2 px-2 overflow-y-auto">
                    {% for concept in knownConcepts %}
                        <a id="{{ concept.id }}" data-answer="{{ concept.answer }}" data-definition="{{ concept.definition }}" href="{% url 'conceptPage' board_id=board.id concept_id=concept.id%}" class="conceptButton knownConcept bg-green-600 rounded-2xl py-1 justify-items-center border text-white text-lg border-black shadow-md shadow-black hover:bg-green-800">
                            <h2 class="font-medium mx-2 my-2">{{ concept.answer }}</h2>
                        </a>
                    {% endfor %}
                    {% for concept in learningConcepts %}
                        <a id="{{ concept.id }}" data-answer="{{ concept.answer }}" data-definition="{{ concept.definition }}" href="{% url 'conceptPage' board_id=board.id concept_id=concept.id%}" class="conceptButton learningConcept bg-yellow-600 rounded-2xl py-1 justify-items-center border text-white text-lg border-black shadow-md shadow-black hover:bg-yellow-800">
                            <h2 class="font-medium mx-2 my-2">{{ concept.answer }}</h2>
                        </a>
                    {% endfor %}
                    {% for concept in unknownConcepts %}
                        <a id="{{ concept.id }}" data-answer="{{ concept.answer }}" data-definition="{{ concept.definition }}" href="{% url 'conceptPage' board_id=board.id concept_id=concept.id%}" class="conceptButton unknownConcept bg-red-500 rounded-2xl py-1 justify-items-center border text-white text-lg border-black shadow-md shadow-black hover:bg-red-800">
                            <h2 class="font-medium mx-2 my-2">{{ concept.answer }}</h2>
                        </a>
                    {% endfor %}
                </div>
                <div id="new-concept-dropdown" class="hidden absolute flex flex-col top-9 right-8 bg-gray-800 gap-y-2 py-2 px-2 w-fit h-fit rounded shadow-md shadow-black"> 
                    <a href="{% url 'newConcept' board.id %}" class="bg-gray-600 px-2 py-1 text-white text-md font-bold rounded hover:shadow-[0_0px_15px_rgba(0,0,0,0.9)] hover:shadow-purple-700 hover:bg-gray-500">Create New Concept</a>
                    <form id="upload-csv" method="POST" action="{% url 'uploadConceptsCSV' board.id%}">
                        {% csrf_token %}
                        <div class="bg-gray-600 justify-items-center px-2 py-1 text-white text-md font-bold rounded hover:shadow-[0_0px_15px_rgba(0,0,0,0.9)] hover:shadow-purple-700 hover:bg-gray-500 flex-row justify-between ">
                            <label for="concept-file" action="{% url 'uploadConceptsCSV' board.id %}" class="cursor-pointer">Upload Concept CSV</label>
                            <input type="file" id="concept-file" name="concept-file" accept=".csv" class="hidden" />
                        </div>
                    </form>
                    <button id="delete-all-concepts" class="bg-gray-600 px-2 py-1 text-center text-white cursor-pointer text-md font-bold rounded hover:shadow-[0_0px_15px_rgba(0,0,0,0.9)] hover:shadow-red-600 hover:bg-gray-500">Delete All Concepts</button>
                    <button id="delete-all-tags" class="bg-gray-600 px-2 py-1 text-center text-white cursor-pointer text-md font-bold rounded hover:shadow-[0_0px_15px_rgba(0,0,0,0.9)] hover:shadow-red-600 hover:bg-gray-500">Delete All Tags</button>
                </div>
                </div>
            </div>
        </div>
    </div>
    <!--Background wrapper to make bg blurry when choosing which settings to load-->
    <div id="modal-backdrop" class="hidden fixed inset-0 z-100 bg-black/50 backdrop-blur-sm flex px-8 items-center justify-center">
        <!--Load Session Settings-->
        <div id="load-settings-modal" class="hidden z-101 flex items-center justify-center w-full h-[80%] ">
            <div class="h-full w-[80%] py-2 bg-gray-800 rounded-2xl px-5 shadow-md shadow-black flex flex-col items-center gap-y-10">
                <div class="w-full h-fit items-center flex flex-row justify-between">
                    <h2 class="text-2xl text-center font-bold text-white pt-2 pb-4">All Session Settings</h2>
                    <button id="close-session-settings" class="h-fit bg-red-500 text-white rounded px-2 py-1">X</button>
                </div>
                <div class="w-full h-[90%] flex flex-col md:grid md:grid-cols-2 md:auto-rows-min gap-4 ">
                {% for sessionSettings in board.sessionSettings.all %} 
                    <!--Href link For Each Button of board session settings so bring you to edit session settings to start a new session -->
                    <a href="{% url 'updateSessionSettings' board.id sessionSettings.id %}" class="bg-gray-700 w-full h-fit rounded-2xl shadow-md shadow-black hover:shadow-[0_0px_15px_rgba(0,0,0,0.9)] hover:shadow-purple-500 hover:bg-gray-600">
                            <div class="flex flex-row justify-between  items-center gap-4 py-3 px-3">
                                <h2 class="text-sm md:text-xl lg:text-2xl text-white font-bold text-left">{{ sessionSettings.title }}</h2>
                                <h2 class="text-sm md:text-xl lg:text-2xl text-white text-right">Length : {{ sessionSettings.numQuestions }}</h2>
                            </div> 
                    </a>
                {% endfor %}
                </div>
            </div>
        </div>
        <!--Confirm Adding CSV File-->
        <div id="csv-confirm-modal" class="hidden flex flex-col fixed inset-x-[25%] inset-y-[40%] w-[50%] h-fit py-2 gap-y-4 rounded-2xl bg-gray-700 z-100 justify-content-center align-items-center">
            <h2 id="csv-concept-text" class="text-2xl text-white text-center"></h2>
            <h2 id="csv-tag-text" class="text-2xl text-white text-center"></h2>
            <button id="confirm-csv-upload" class="bg-red-500 py-1 rounded w-fit h-fit text-lg font-bold px-4 hover:bg-red-800">Upload</button>
            <button id="cancel-csv-upload" class="absolute top-2 right-2 bg-red-600 rounded px-2 text-white hover:bg-red-800">X</button>
        </div>
        <!--Confirm Deleting all Concepts-->
        <div id="delete-all-concepts-confirm-modal" class=" hidden flex w-full h-full items-center justify-center z-101">
            <div class="flex flex-col w-fit h-fit py-2 gap-y-4 rounded-2xl bg-gray-700 z-100 justify-center items-center">
                <div class="flex flex-row w-full h-fit justify-center px-5 gap-x-2">
                    <h2 id="delete-all-concepts-text" class="text-sm md:text-lg lg:text-2xl text-white text-center">Are you sure you want to delete {{ conceptsCount }} concepts <span class="text-red-600 font-bold">FOREVER?</span></h2>
                    <button id="cancel-delete-all-concepts" class="h-fit bg-red-600 justify-end rounded px-2 py-1 text-white hover:bg-red-800">X</button>
                </div>
                <a href="{% url 'deleteAllConcepts' board.id %}" id="confirm-delete-all" class="bg-red-500 py-1 rounded w-fit h-fit text-lg font-bold px-4 hover:bg-red-800">Delete All</a>
            </div>
        </div>
        <!--Confirm Deleting all Tags-->
        <div id="delete-all-tags-confirm-modal" class=" hidden flex w-full h-full items-center justify-center z-101">
            <div class="flex flex-col w-fit h-fit py-2 gap-y-4 rounded-2xl bg-gray-700 z-100 justify-center items-center">
                <div class="flex flex-row w-full h-fit justify-center px-5 gap-x-2">
                    <h2 id="delete-all-tags-text" class="text-sm md:text-lg lg:text-2xl text-white text-center">Are you sure you want to delete {{ tagsCount }} tags <span class="text-red-600 font-bold">FOREVER?</span></h2>
                    <button id="cancel-delete-all-tags" class="absolute top-2 right-2 bg-red-600 rounded px-2 text-white hover:bg-red-800">X</button>
                </div>
            <a href="{% url 'deleteAllTags' board.id %}" class="bg-red-500 py-1 rounded w-fit h-fit text-lg font-bold px-4 hover:bg-red-800">Delete All</a>
        </div>  
    </div>
   {% if board %}
        {{ questions|json_script:'questions-data'}}
        {{ boardQuestions|json_script:'board-questions-data'}}
    {% endif %}
    <script>
        const boardID = "{{ board.id }}";
        const newTags = "{{ newTags }}" || null;
        const newConcepts = "{{ newConcepts }}" || null;
        const allQuestions = JSON.parse(document.getElementById('questions-data').textContent)
        const boardQuestions = JSON.parse(document.getElementById('board-questions-data').textContent)
        const sessionsSettingsDropdown = document.getElementById('sessions-settings-dropdown');
        const toggleSessionsSettingsDropdown = document.getElementById('toggle-sessions-settings');
        const modalBackdrop = document.getElementById('modal-backdrop');
        const loadSessionsSettings = document.getElementById('load-sessions-settings');
        const loadSettingsModal = document.getElementById('load-settings-modal');
        const toggleNewConceptBtn = document.getElementById('toggle-new-concept');
        const newConceptDropdown = document.getElementById('new-concept-dropdown');
        const closeSessionSettings = document.getElementById('close-session-settings');

        const conceptCSVInput = document.getElementById('concept-file');
        const uploadCSVForm = document.getElementById('upload-csv');
        const confirmCSV = document.getElementById('csv-confirm-modal');
        const csvConceptText = document.getElementById('csv-concept-text');
        const csvTagText = document.getElementById('csv-tag-text');
        const confirmCSVUpload = document.getElementById('confirm-csv-upload');
        const cancelCSVUpload = document.getElementById('cancel-csv-upload');

        const knownConceptsButton = document.getElementById('known-concepts-button');
        const learningConceptsButton = document.getElementById('learning-concepts-button');
        const unknownConceptsButton = document.getElementById('unknown-concepts-button');
        const clearConceptsButton = document.getElementById('clear-concepts-button');
        const conceptButtons = document.querySelectorAll('.conceptButton');
        const knownConcepts = document.querySelectorAll('.knownConcept');
        const learningConcepts = document.querySelectorAll('.learningConcept');
        const unknownConcepts = document.querySelectorAll('.unknownConcept');
        const conceptSearch = document.getElementById('concept-search');
        const csrfToken = document.querySelector('meta[name=csrf_token]').getAttribute('content');

        const confirmDeleteAllConceptsModal = document.getElementById('delete-all-concepts-confirm-modal');
        const confirmDeleteAllConceptsText = document.getElementById('delete-all-concepts-text');
        const cancelDeleteAllConceptsBtn = document.getElementById('cancel-delete-all-concepts');
        const deleteAllConcepts = document.getElementById('delete-all-concepts');

        const confirmDeleteAllTagsModal = document.getElementById('delete-all-tags-confirm-modal');
        const confirmDeleteAllTagsText = document.getElementById('delete-all-tags-text');
        const cancelDeleteAllTagsBtn = document.getElementById('cancel-delete-all-tags');
        const deleteAllTags = document.getElementById('delete-all-tags');


        modalBackdrop.addEventListener('click', () =>{
            if(!modalBackdrop.classList.contains('hidden')) {
                modalBackdrop.classList.add('hidden');
            }
            if(!deleteAllConcepts.classList.contains('hidden')) {
                confirmDeleteAllConceptsModal.classList.add('hidden');
            } if (!confirmDeleteAllTagsModal.classList.contains('hidden')) {
                confirmDeleteAllTagsModal.classList.add('hidden');
            }
        })

        closeSessionSettings.addEventListener('click', () => {
            modalBackdrop.classList.toggle('hidden');
            loadSettingsModal.classList.toggle('hidden');
        });

        deleteAllConcepts.addEventListener('click', () => {
            confirmDeleteAllConceptsModal.classList.toggle('hidden');
            modalBackdrop.classList.toggle('hidden');
        });

        cancelDeleteAllConceptsBtn.addEventListener('click', () => {
           confirmDeleteAllConceptsModal.classList.toggle('hidden');
           modalBackdrop.classList.toggle('hidden');
        });

        deleteAllTags.addEventListener('click', () => {
            confirmDeleteAllTagsModal.classList.toggle('hidden');
            modalBackdrop.classList.toggle('hidden');
        });
        
        cancelDeleteAllTagsBtn.addEventListener('click', () => {
                confirmDeleteAllTagsModal.classList.toggle('hidden');
            modalBackdrop.classList.toggle('hidden');
        });

        knownConceptsButton.addEventListener('click', () => {
            knownConcepts.forEach(btn => {
                btn.classList.toggle('hidden');
            });
            learningConcepts.forEach(btn => {
                if(!btn.classList.contains('hidden')){ btn.classList.add('hidden');}
                else { btn.classList.remove('hidden'); }
            });
            unknownConcepts.forEach(btn => {
                if(!btn.classList.contains('hidden')){btn.classList.add('hidden');}
                else { btn.classList.remove('hidden'); }
            });
        });
        learningConceptsButton.addEventListener('click', () => {
            learningConcepts.forEach(btn => {
                btn.classList.remove('hidden');
            });
            knownConcepts.forEach(btn => {
                if(!btn.classList.contains('hidden')){ btn.classList.add('hidden');}
                else { btn.classList.remove('hidden'); }
            });
            unknownConcepts.forEach(btn => {
                if(!btn.classList.contains('hidden')){btn.classList.add('hidden');}
                else { btn.classList.remove('hidden'); }
            });

        });
        unknownConceptsButton.addEventListener('click', () => {
            learningConcepts.forEach(btn => {
                if(!btn.classList.contains('hidden')){ btn.classList.add('hidden');}
                else { btn.classList.remove('hidden'); }
            });
            knownConcepts.forEach(btn => {
                if(!btn.classList.contains('hidden')){btn.classList.add('hidden');}
                else { btn.classList.remove('hidden'); }
            });
            unknownConcepts.forEach(btn => {
                btn.classList.remove('hidden');
            });
        });
        clearConceptsButton.addEventListener('click', () => {
            unknownConcepts.forEach(btn => {
                btn.classList.remove('hidden');
            });
           learningConcepts.forEach(btn => {
                btn.classList.remove('hidden');
            });
            knownConcepts.forEach(btn => {
                btn.classList.remove('hidden');
            });
        });

        cancelCSVUpload.addEventListener('click', () => {
            confirmCSV.classList.toggle('hidden');
            modalBackdrop.classList.toggle('hidden');
        });

        conceptCSVInput.addEventListener('change', () => {
            if(conceptCSVInput.files.length) {

                const formData = new FormData();
                formData.append('file', conceptCSVInput.files[0]);
                formData.append('confirm', false);

                fetch(`/board/${boardID}/uploadConcepts/`, {
                    method : 'POST',
                    headers : {
                        'X-CSRFToken' : csrfToken
                    },
                    body : formData
                })
                .then(res => res.json())
                .then(data => {
                    if(data.success) {
                        confirmCSV.classList.toggle('hidden');
                        modalBackdrop.classList.toggle('hidden');

                        const newConceptsCount = data.newConceptsCount ?? 0;
                        const newTagsCount = data.newTagsCount ?? 0;

                        csvConceptText.textContent = `Are you sure you want to add ${newConceptsCount} new concepts?`;
                        csvTagText.textContent = `Are you sure you want to add ${newTagsCount} new tags?`;
                        confirmCSVUpload.onclick = () => {
                            const confirmFormData = new FormData();
                            confirmFormData.append('confirm', true);
                            confirmFormData.append('file', conceptCSVInput.files[0]);
                            fetch(`/board/${boardID}/uploadConcepts/`, {
                                method : 'POST',
                                headers : {
                                    'X-CSRFToken' : csrfToken
                                },
                                body : confirmFormData 
                            })
                            .then(res => res.json())
                            .then(data => {
                                if(data.success) {
                                    window.location.reload()
                                } else {
                                    console.error('Upload Failed', data);
                                }
                            })
                            .catch(err => console.error('Upload Failed', err))
                        }
                    }
                });
            }
        });

        loadSessionsSettings.addEventListener('click', (e) => {
            e.stopPropagation();
            loadSettingsModal.classList.remove('hidden');
            modalBackdrop.classList.remove('hidden');
        })

        toggleSessionsSettingsDropdown.addEventListener('click', (e) => {
            sessionsSettingsDropdown.classList.toggle('hidden');
        });

        toggleNewConceptBtn.addEventListener('click', (e) => {
            newConceptDropdown.classList.toggle('hidden');
        })
    
        document.addEventListener('click', (e) => {
            if(!newConceptDropdown.contains(e.target) && !newConceptDropdown.classList.contains('hidden') && !toggleNewConceptBtn.contains(e.target)){
                newConceptDropdown.classList.add('hidden');
            } 
            if(!sessionsSettingsDropdown.contains(e.target) && !sessionsSettingsDropdown.classList.contains('hidden') && !toggleSessionsSettingsDropdown.contains(e.target)) {
                sessionsSettingsDropdown.classList.add('hidden')
            }
            if (e.target === modalBackdrop) {
                loadSettingsModal.classList.add('hidden');
                modalBackdrop.classList.add('hidden');
            }
        });

        conceptSearch.addEventListener('input', (e) => {
            const normalize = str => str.normalize('NFKC');
            const searchVal = normalize(e.target.value.toLowerCase());
            conceptButtons.forEach(btn => {
                console.log(btn.dataset.answer, btn.dataset.definition);
                const answer = normalize(btn.dataset.answer || '').toLowerCase();
                const definition = normalize(btn.dataset.definition || '').toLowerCase();
                if(!answer.includes(searchVal) && !definition.includes(searchVal)) {
                    btn.classList.add('hidden');
                } else {
                    btn.classList.remove('hidden');
                }
            });
        });
    
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.local-time').forEach(span => {
                const UTCDate = new Date(span.dataset.time);
                span.textContent = UTCDate.toLocaleString('en-US', {
                    year : 'numeric',
                    month : 'short',
                    day : 'numeric',
                    hour : 'numeric',
                    minute : 'numeric'
                });
            });
        });

    </script>
{% endblock %}